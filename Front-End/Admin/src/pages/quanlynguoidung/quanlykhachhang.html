<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Trang chủ Admin</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="../../assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="../../assets/images/favicon.png" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
  </head>
  <body>
    <div class="container-scroller">
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row" id="navbar-placeholder"></nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar"></nav>
        <!-- partial -->
        <div class="main-panel"style="font-family: 'Times New Roman', Times, serif;">
          <div class="content-wrapper">
            <div class="page-header">
              <h3 class="page-title" style="font-family: 'Times New Roman', Times, serif;">Quản lý Khách hàng</h3>
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#">Quản lý</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Khách hàng</li>
                </ol>
              </nav>
            </div>
              <!-- Tìm kiếm và sắp xếp -->
              <div class="row mb-3">
                  <div class="col-md-4">
                      <label for="searchInput" class="form-label">Tìm kiếm:</label>
                      <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên, email, địa chỉ...">
                  </div>
                  <div class="col-md-4">
                      <label for="sortSelect" class="form-label">Sắp xếp theo:</label>
                      <select class="form-select" id="sortSelect">
                          <option value="">Mặc định</option>
                          <option value="makh">Mã Khách hàng</option>
                          <option value="tenkh">Tên Khách hàng</option>
                          <option value="email">Email</option>
                      </select>
                  </div>
                  <div class="col-md-4">
                      <label for="sortOrderSelect" class="form-label">Thứ tự:</label>
                      <select class="form-select" id="sortOrderSelect">
                          <option value="asc">Tăng dần</option>
                          <option value="desc">Giảm dần</option>
                      </select>
                  </div>
              </div>

            <div class="row">
              <div class="col-lg-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">Danh sách Khách hàng</h4>
                    <!-- Nút thêm khách hàng -->
                    <button class="btn btn-primary mb-3" id="btnAddKhachHang"style="font-family: 'Times New Roman', Times, serif;">Thêm Khách hàng</button>
        
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th style="font-family: 'Times New Roman', Times, serif;">Mã KH</th>
                            <th style="font-family: 'Times New Roman', Times, serif;">Tên KH</th>
                            <th style="font-family: 'Times New Roman', Times, serif;">Số Điện Thoại</th>
                            <th style="font-family: 'Times New Roman', Times, serif;">Email</th>
                            <th style="font-family: 'Times New Roman', Times, serif;">Địa Chỉ</th>
                            <th style="font-family: 'Times New Roman', Times, serif;">Hành động</th>
                          </tr>
                        </thead>
                        <tbody id="tableBody">
                          <!-- Dữ liệu khách hàng sẽ được thêm vào đây bằng JavaScript -->
                        </tbody>
                      </table>
                    </div>
                     <!-- Phân trang -->
                     <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <li class="page-item"><a class="page-link" href="#" id="prevPage">Trước</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="nextPage">Sau</a></li>
                        </ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- content-wrapper ends -->
          <!-- partial:partials/_footer.html -->
          <footer class="footer" id="footer"></footer>
          <!-- partial -->
        </div>
        
        <!-- Modal để thêm/sửa khách hàng -->
        <div class="modal fade" id="khachHangModal" tabindex="-1" aria-labelledby="khachHangModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content"style="font-family: 'Times New Roman', Times, serif;">
              <div class="modal-header">
                <h5 class="modal-title" id="khachHangModalLabel">Thêm Khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="khachHangForm">
                  <div class="mb-3">
                    <label for="maKH" class="form-label">Mã KH</label>
                    <input type="text" class="form-control" id="maKH" name="maKH" required>
                  </div>
                  <div class="mb-3">
                    <label for="tenKH" class="form-label">Tên KH</label>
                    <input type="text" class="form-control" id="tenKH" name="tenKH" required>
                  </div>
                  <div class="mb-3">
                    <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
                    <input type="text" class="form-control" id="soDienThoai" name="soDienThoai">
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email">
                  </div>
                  <div class="mb-3">
                    <label for="diaChi" class="form-label">Địa Chỉ</label>
                    <input type="text" class="form-control" id="diaChi" name="diaChi">
                  </div>
                  <input type="hidden" id="isEdit" name="isEdit" value="false">
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-family: 'Times New Roman', Times, serif;">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnSaveKhachHang" style="font-family: 'Times New Roman', Times, serif;">Lưu</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <script src="../../assets/js/settings.js"></script>
    <script src="../../assets/js/todolist.js"></script>
    <script src="../../assets/js/jquery.cookie.js"></script>
    <script>
      fetch("/Admin/src/partials/_navbar.html")
          .then(response => response.text())
          .then(data => {
              document.getElementById("navbar-placeholder").innerHTML = data;
          })
          .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>
    <script>
      fetch("/Admin/src/partials/_sidebar.html")
          .then(response => response.text())
          .then(data => {
              document.getElementById("sidebar").innerHTML = data;
          })
          .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>
    <script>
      fetch("/Admin/src/partials/_footer.html")
          .then(response => response.text())
          .then(data => {
              document.getElementById("footer").innerHTML = data;
          })
          .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>
    <script>
      const apiUrl = 'http://localhost:5073/api/KhachHang';
      const tableBody = document.getElementById('tableBody');
      const btnAddKhachHang = document.getElementById('btnAddKhachHang');
      const khachHangModal = new bootstrap.Modal(document.getElementById('khachHangModal'));
      const khachHangForm = document.getElementById('khachHangForm');
      const btnSaveKhachHang = document.getElementById('btnSaveKhachHang');
      const isEdit = document.getElementById('isEdit');

      // Get references to the search and sort elements
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const sortOrderSelect = document.getElementById('sortOrderSelect');

      //Phân trang
      const prevPageButton = document.getElementById('prevPage');
      const nextPageButton = document.getElementById('nextPage');
      let currentPage = 1;
      const pageSize = 5;  //Số lượng item một trang

      // Function to build API URL with search, sort, and pagination parameters
      function buildApiUrl(searchTerm = '', sortBy = '', sortOrder = 'asc', page = 1, pageSize = 5) {
          let url = apiUrl + '?';

          if (searchTerm) {
              url += 'searchTerm=' + encodeURIComponent(searchTerm) + '&';
          }

          if (sortBy) {
              url += 'sortBy=' + encodeURIComponent(sortBy) + '&';
          }

          if (sortOrder) {
              url += 'sortOrder=' + encodeURIComponent(sortOrder) + '&';
          }

          //Add pagination parameters
          url += 'page=' + encodeURIComponent(page) + '&';
          url += 'pageSize=' + encodeURIComponent(pageSize) + '&';


          // Remove the trailing '&' if any
          if (url.endsWith('&')) {
              url = url.slice(0, -1);
          }
          return url;
      }

      // Function to fetch data from API and display on the table
      async function loadKhachHangs(url) {
          tableBody.innerHTML = ''; // Clear old data
          try {
              const response = await fetch(url);
              const khachHangs = await response.json();

              khachHangs.forEach(khachHang => {
                  const row = `
                      <tr>
                          <td>${khachHang.maKH}</td>
                          <td>${khachHang.tenKH}</td>
                          <td>${khachHang.soDienThoai || ''}</td>
                          <td>${khachHang.email || ''}</td>
                          <td>${khachHang.diaChi || ''}</td>
                          <td>
                              <button class="btn btn-sm btn-warning btnEdit" data-id="${khachHang.maKH}" style="font-family: 'Times New Roman', Times, serif;">Sửa</button>
                              <button class="btn btn-sm btn-danger btnDelete" data-id="${khachHang.maKH}" style="font-family: 'Times New Roman', Times, serif;">Xóa</button>
                          </td>
                      </tr>
                  `;
                  tableBody.innerHTML += row;
              });

              // Assign events for Edit and Delete buttons after adding to DOM
              document.querySelectorAll('.btnEdit').forEach(button => {
                  button.addEventListener('click', editKhachHang);
              });

              document.querySelectorAll('.btnDelete').forEach(button => {
                  button.addEventListener('click', deleteKhachHang);
              });
          } catch (error) {
              console.error('Error loading data:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'Lỗi',
                  text: 'Lỗi khi tải dữ liệu. Vui lòng kiểm tra console.',
              });
          }
      }

      // Event listener for search input
      searchInput.addEventListener('input', () => {
          const searchTerm = searchInput.value;
          const sortBy = sortSelect.value;
          const sortOrder = sortOrderSelect.value;
          currentPage = 1;  //Reset về trang đầu tiên khi search
          const apiUrl = buildApiUrl(searchTerm, sortBy, sortOrder, currentPage, pageSize);
          loadKhachHangs(apiUrl);
      });

      // Event listeners for sort select boxes
      sortSelect.addEventListener('change', () => {
          const searchTerm = searchInput.value;
          const sortBy = sortSelect.value;
          const sortOrder = sortOrderSelect.value;
          currentPage = 1;   //Reset về trang đầu tiên khi sort
          const apiUrl = buildApiUrl(searchTerm, sortBy, sortOrder, currentPage, pageSize);
          loadKhachHangs(apiUrl);
      });

      sortOrderSelect.addEventListener('change', () => {
          const searchTerm = searchInput.value;
          const sortBy = sortSelect.value;
          const sortOrder = sortOrderSelect.value;
          currentPage = 1;   //Reset về trang đầu tiên khi sortOrder
          const apiUrl = buildApiUrl(searchTerm, sortBy, sortOrder, currentPage, pageSize);
          loadKhachHangs(apiUrl);
      });

      //Add event listeners for the pagination buttons
      prevPageButton.addEventListener('click', () => {
          if (currentPage > 1) {
              currentPage--;
              const searchTerm = searchInput.value;
              const sortBy = sortSelect.value;
              const sortOrder = sortOrderSelect.value;
              const apiUrl = buildApiUrl(searchTerm, sortBy, sortOrder, currentPage, pageSize);
              loadKhachHangs(apiUrl);
          }
      });

      nextPageButton.addEventListener('click', () => {
          currentPage++;
          const searchTerm = searchInput.value;
          const sortBy = sortSelect.value;
          const sortOrder = sortOrderSelect.value;
          const apiUrl = buildApiUrl(searchTerm, sortBy, sortOrder, currentPage, pageSize);
          loadKhachHangs(apiUrl);
      });


      // Load initial data with default values.
      loadKhachHangs(buildApiUrl());

      // Function to add customer
      btnAddKhachHang.addEventListener('click', () => {
          khachHangForm.reset(); // Reset form
          isEdit.value = 'false'; // Set mode to add new
          khachHangModal.show();
      });

      // Function to edit customer
      async function editKhachHang(event) {
          const id = event.target.dataset.id;
          isEdit.value = 'true';
          khachHangForm.reset(); // Reset form
          try {
              const response = await fetch(`${apiUrl}/${id}`);
              const khachHang = await response.json();

              // Fill data into the form
              khachHangForm.maKH.value = khachHang.maKH;
              khachHangForm.tenKH.value = khachHang.tenKH;
              khachHangForm.soDienThoai.value = khachHang.soDienThoai || '';
              khachHangForm.email.value = khachHang.email || '';
              khachHangForm.diaChi.value = khachHang.diaChi || '';

              khachHangModal.show(); // Show modal
          } catch (error) {
              console.error('Error loading customer data:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'Lỗi',
                  text: 'Lỗi khi tải dữ liệu khách hàng.',
              });
          }
      }

      // Function to delete customer
      async function deleteKhachHang(event) {
          const id = event.target.dataset.id;
          Swal.fire({
              title: 'Bạn có chắc chắn muốn xóa khách hàng này không?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Có, Xóa!',
              cancelButtonText: 'Không, Hủy!'
          }).then(async (result) => {
              if (result.isConfirmed) {
                  try {
                      const response = await fetch(`${apiUrl}/${id}`, {
                          method: 'DELETE',
                      });

                      if (response.status === 204) {
                          Swal.fire(
                              'Đã xóa!',
                              'Khách hàng đã được xóa.',
                              'success'
                          );
                          loadKhachHangs(buildApiUrl());  //Load lại trang hiện tại
                      } else {
                          Swal.fire({
                              icon: 'error',
                              title: 'Lỗi',
                              text: 'Xóa không thành công. Vui lòng kiểm tra console.',
                          });
                          console.error('Error:', response.status);
                      }
                  } catch (error) {
                      console.error('Error deleting customer:', error);
                      Swal.fire({
                          icon: 'error',
                          title: 'Lỗi',
                          text: 'Lỗi khi xóa khách hàng. Vui lòng kiểm tra console.',
                      });
                  }
              }
          });
      }

      // Function to save customer (add or edit)
      btnSaveKhachHang.addEventListener('click', async () => {
          const formData = new FormData(khachHangForm);
          const khachHangData = {
              maKH: formData.get('maKH'),
              tenKH: formData.get('tenKH'),
              soDienThoai: formData.get('soDienThoai'),
              email: formData.get('email'),
              diaChi: formData.get('diaChi')
          };

          const isEditMode = isEdit.value === 'true';

          try {
              let response;
              if (isEditMode) {
                  // Edit
                  response = await fetch(`${apiUrl}/${khachHangData.maKH}`, {
                      method: 'PUT',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(khachHangData)
                  });
              } else {
                  // Add
                  response = await fetch(apiUrl, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(khachHangData)
                  });
              }

              if (response.ok || response.status === 204) { // Check response.ok or status 204
                  Swal.fire({
                      icon: 'success',
                      title: isEditMode ? 'Cập nhật thành công!' : 'Thêm thành công!',
                      text: isEditMode ? 'Khách hàng đã được cập nhật.' : 'Khách hàng đã được thêm.',
                  });
                  khachHangModal.hide(); // Hide modal
                  loadKhachHangs(buildApiUrl()); //Load lại trang hiện tại
              } else {
                  Swal.fire({
                      icon: 'error',
                      title: 'Lỗi',
                      text: 'Thêm/sửa không thành công. Vui lòng kiểm tra console.',
                  });
                  console.error('Error:', response.status);
              }
          } catch (error) {
              console.error('Error adding/editing customer:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'Lỗi',
                  text: 'Lỗi khi thêm/sửa khách hàng. Vui lòng kiểm tra console.',
              });
          }
      });
    </script>
  </body>
</html>