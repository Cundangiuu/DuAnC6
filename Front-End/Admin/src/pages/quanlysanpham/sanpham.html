<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Quản lý Sản phẩm</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="../../assets/vendors/font-awesome/css/font-awesome.min.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href="../../assets/css/style.css">
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="../../assets/css/style.css">
  <!-- End layout styles -->
  <link rel="shortcut icon" href="../../assets/images/favicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
  <style>
    .table-responsive {
      overflow-x: auto;
      /* Enable horizontal scroll for small screens */
    }

    .table th,
    .table td {
      white-space: nowrap;
      /* Prevent text wrapping in table cells */
    }

    .drop-area {
      border: 2px dashed #ccc;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .drop-area.highlight {
      border-color: #007bff;
      /* Màu khi kéo file vào */
    }

    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      /* Cho phép preview xuống hàng khi nhiều ảnh */
    }

    .image-preview {
      position: relative;
      /* Cần thiết để định vị nút xóa */
      margin: 5px;
    }

    .image-preview img {
      max-width: 100px;
      /* Kích thước preview */
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      object-fit: cover;
      /* Đảm bảo ảnh không bị méo */
    }

    .remove-image-button {
      position: absolute;
      /* Định vị nút xóa ở góc trên phải preview */
      top: -5px;
      right: -5px;
      background-color: rgba(255, 0, 0, 0.7);
      /* Nền đỏ mờ */
      color: white;
      border: none;
      border-radius: 50%;
      /* Hình tròn */
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      /* Ẩn nút xóa ban đầu */
      transition: opacity 0.2s ease-in-out;
      /* Hiệu ứng fade in/out */
    }

    .image-preview:hover .remove-image-button {
      opacity: 1;
      /* Hiện nút xóa khi hover vào preview */
    }
  </style>
</head>

<body>
  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row" id="navbar-placeholder">
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_sidebar.html -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar"></nav>
      <!-- partial -->
      <div class="main-panel" style="font-family: 'Times New Roman', Times, serif;" >
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title" style="font-family: 'Times New Roman', Times, serif;"> Quản lý Sản phẩm </h3>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Sản phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page">Danh sách sản phẩm</li>
              </ol>
            </nav>
          </div>
          <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title"style="font-family: 'Times New Roman', Times, serif;">Danh sách Sản phẩm</h4>
                  <div class="row mb-3">
                    <div class="col-md-12 mb-3">
                      <div class="row">
                        <!-- Category Filter -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="categoryFilter">Danh mục</label>
                            <select class="form-control" id="categoryFilter" name="categoryFilter">
                              <option value="">Tất cả danh mục</option>
                              <!-- Categories will be loaded here -->
                            </select>
                          </div>
                        </div>
                        <!-- Status Filter -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="statusFilter">Trạng thái</label>
                            <select class="form-control" id="statusFilter">
                              <option value="">Tất cả trạng thái</option>
                              <option value="true">Còn hàng</option>
                              <option value="false">Hết hàng</option>
                            </select>
                          </div>
                        </div>
                        <!-- Sorting Dropdown -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="sortBy">Sắp xếp theo</label>
                            <select class="form-control" id="sortBy">
                              <option value="">Mặc định</option>
                              <option value="TenSP_asc">Tên sản phẩm (A-Z)</option>
                              <option value="TenSP_desc">Tên sản phẩm (Z-A)</option>
                              <!-- Add more sorting options here if needed -->
                            </select>
                          </div>
                        </div>

                      </div>
                    </div>
                    <div class="col-md-6 text-left">
                      <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm sản phẩm..."
                          aria-label="Tìm kiếm sản phẩm">
                        <div class="input-group-append" style="display: none;">
                          <button class="btn btn-sm btn-primary" type="button" id="searchButton">Tìm kiếm</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 text-md-right">
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addProductModal" style="font-family: 'Times New Roman', Times, serif;">
                        <i class="mdi mdi-plus-circle-outline"></i> Thêm Sản phẩm
                      </button>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th style="font-family: 'Times New Roman', Times, serif;">Tên Sản phẩm</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Hình Ảnh</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Danh mục</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Nhà cung cấp</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Số Lượng Tồn</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Trạng Thái</th>
                          <th style="font-family: 'Times New Roman', Times, serif;">Thao tác</th> <!-- Vẫn giữ cột thao tác -->
                        </tr>
                      </thead>
                      <tbody id="productTableBody">
                        <!-- Product rows will be inserted here by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-3 d-flex justify-content-center">
                    <nav aria-label="Product pagination">
                      <ul class="pagination">
                        <li class="page-item" id="previousPage">
                          <button class="page-link" aria-label="Previous">
                            <span aria-hidden="true">«</span>
                            <span class="sr-only">Previous</span>
                          </button>
                        </li>
                        <li class="page-item disabled"><span class="page-link" id="currentPageNumber">1</span></li>
                        <li class="page-item" id="nextPage">
                          <button class="page-link" aria-label="Next">
                            <span aria-hidden="true">»</span>
                            <span class="sr-only">Next</span>
                          </button>
                        </li>
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->

        <!--  Add Product Modal -->
        <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel"
          aria-hidden="true">
          <div class="modal-dialog " role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel" style="font-family: 'Times New Roman', Times, serif;">Thêm Sản phẩm mới</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="addProductForm" data-product-form="add">
                  <div class="form-group">
                    <!-- <label for="maSP">Mã Sản Phẩm</label> -->
                    <input type="hidden" class="form-control" id="maSP" name="maSP">
                  </div>
                  <div class="form-group">
                    <label for="tenSP">Tên Sản Phẩm</label>
                    <input type="text" class="form-control" id="tenSP" name="tenSP" required>
                  </div>
                  <div class="form-group">
                    <label for="giaNhap">Giá Nhập</label>
                    <input type="number" class="form-control" id="giaNhap" name="giaNhap" min="0" step="1" required>
                  </div>
                  <div class="form-group">
                    <label for="giaBan">Giá Bán</label>
                    <input type="number" class="form-control" id="giaBan" name="giaBan" min="0" step="1" required>
                  </div>
                  <div class="form-group">
                    <label for="soLuongTon">Số Lượng Tồn</label>
                    <input type="number" class="form-control" id="soLuongTon" name="soLuongTon" min="0" required>
                  </div>
                  <div class="form-group">
                    <label for="donViTinh">Đơn Vị Tính</label>
                    <input type="text" class="form-control" id="donViTinh" name="donViTinh">
                  </div>
                  <div class="form-group">
                    <label>Hình Ảnh Sản Phẩm</label>
                    <div id="addProductImageUploadArea" class="drop-area">
                      <p>Kéo và thả hình ảnh vào đây hoặc</p>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-upload-image">Chọn hình ảnh từ
                        máy tính</button>
                      <input type="file" id="addProductImageFile" name="hinhAnhFiles" multiple style="display:none;"
                        accept="image/*">
                    </div>
                    <div id="addProductImagePreview" class="image-preview-container">
                      <!-- Hình ảnh preview sẽ được hiển thị ở đây -->
                    </div>
                  </div>
              </div>
              <div class="form-group">
                <label for="maDanhMuc">Danh mục sản phẩm</label>
                <select class="form-control" id="maDanhMuc" name="maDanhMuc" required>
                  <option value="">Chọn danh mục</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
              <div class="form-check form-check-primary">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="trangThai" name="trangThai" checked>
                  Còn hàng <i class="input-helper"></i>
                </label>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" data-action="save">Lưu Sản phẩm</button>
              </div>
              </form>
            </div>

          </div>
        </div>


        <!-- Edit Product Modal -->
        <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog"
          aria-labelledby="editProductModalLabel" aria-hidden="true">
          <div class="modal-dialog " role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel"style="font-family: 'Times New Roman', Times, serif;">Chỉnh sửa Sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="editProductForm" data-product-form="edit">
                  <input type="hidden" id="editMaSP" name="maSP">
                  <div class="form-group">
                    <label for="editTenSP">Tên Sản Phẩm</label>
                    <input type="text" class="form-control" id="editTenSP" name="tenSP" required>
                  </div>
                  <div class="form-group">
                    <label for="editGiaNhap">Giá Nhập</label>
                    <input type="number" class="form-control" id="editGiaNhap" name="giaNhap" min="0" step="0.01"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="editGiaBan">Giá Bán</label>
                    <input type="number" class="form-control" id="editGiaBan" name="giaBan" min="0" step="0.01"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="editSoLuongTon">Số Lượng Tồn</label>
                    <input type="number" class="form-control" id="editSoLuongTon" name="soLuongTon" min="0" required>
                  </div>
                  <div class="form-group">
                    <label for="editDonViTinh">Đơn Vị Tính</label>
                    <input type="text" class="form-control" id="editDonViTinh" name="donViTinh">
                  </div>
                  <div class="form-group">
                    <label>Hình Ảnh Sản Phẩm</label>
                    <div id="editProductImageUploadArea" class="drop-area">
                      <p>Kéo và thả hình ảnh vào đây hoặc</p>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-upload-image">Chọn hình ảnh từ
                        máy
                        tính</button>
                      <input type="file" id="editProductImageFile" name="hinhAnhFiles" multiple style="display:none;"
                        accept="image/*">
                    </div>
                    <div id="editProductImagePreview" class="image-preview-container">
                      <!-- Hình ảnh preview sẽ được hiển thị ở đây -->
                    </div>
                  </div>
              </div>
              <div class="form-group">
                <label for="editMaDanhMuc">Danh mục sản phẩm</label>
                <select class="form-control" id="editMaDanhMuc" name="maDanhMuc" required>
                  <option value="">Chọn danh mục</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
              <div class="form-check form-check-primary">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editTrangThai" name="trangThai">
                  Còn hàng <i class="input-helper"></i>
                </label>
              </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
              <button type="button" class="btn btn-primary" data-action="update">Lưu Thay Đổi</button>
            </div>
          </div>
        </div>


        <!-- View Product Modal -->
        <div class="modal fade" id="viewProductModal" tabindex="-1" role="dialog"
          aria-labelledby="viewProductModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document"> <!-- modal-lg để modal rộng hơn -->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="viewProductModalLabel"style="font-family: 'Times New Roman', Times, serif;">Chi tiết Sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body" id="viewProductDetails">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Mã Sản Phẩm:</strong> <span data-product-detail="maSP"></span></p>
                    <p><strong>Tên Sản Phẩm:</strong> <span data-product-detail="tenSP"></span></p>
                    <p><strong>Danh mục:</strong> <span data-product-detail="danhMuc"></span></p>
                    <p><strong>Nhà cung cấp:</strong> <span data-product-detail="nhaCungCap"></span></p>
                    <p><strong>Đơn Vị Tính:</strong> <span data-product-detail="donViTinh"></span></p>
                    <p><strong>Trạng Thái:</strong> <span data-product-detail="trangThai"></span></p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Giá Nhập:</strong> <span data-product-detail="giaNhap"></span></p>
                    <p><strong>Giá Bán:</strong> <span data-product-detail="giaBan"></span></p>
                    <p><strong>Số Lượng Tồn:</strong> <span data-product-detail="soLuongTon"></span></p>
                    <p><strong>Hình Ảnh:</strong> <span data-product-detail="hinhAnh"></span></p>
                  </div>
                </div>
                <!-- Thêm các trường thông tin chi tiết khác nếu cần -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
              </div>
            </div>
          </div>
        </div>
      </div>



      <!-- content-wrapper ends -->
      <!-- partial:partials/_footer.html -->
      <footer class="footer" id="footer"></footer>
      <!-- partial -->
    </div>
    <!-- main-panel ends -->
  </div>
  <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <!-- plugins:js -->
  <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="../../assets/js/off-canvas.js"></script>
  <script src="../../assets/js/misc.js"></script>
  <script src="../../assets/js/settings.js"></script>
  <script src="../../assets/js/todolist.js"></script>
  <script src="../../assets/js/jquery.cookie.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <!-- End custom js for this page -->
  <!-- Bootstrap Modal JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- <script>
    // Function to load partial HTML content using Fetch API
    function loadPartial(partialName, elementId) {
      fetch(`/Admin/src/partials/${partialName}.html`) // Adjust path if needed
        .then(response => response.text())
        .then(data => {
          document.getElementById(elementId).innerHTML = data;
        })
        .catch(error => console.error(`Error loading ${partialName}:`, error));
    }

    $(document).ready(function () {
      loadPartial('_navbar', 'navbar-placeholder');
      loadPartial('_sidebar', 'sidebar');
      loadPartial('_footer', 'footer');
    });
  </script> -->

<script>
  // Function to load partial HTML content using Fetch API
  function loadPartial(partialName, elementId) {
    fetch(`/Admin/src/partials/${partialName}.html`) // Adjust path if needed
      .then(response => response.text())
      .then(data => {
        document.getElementById(elementId).innerHTML = data;
      })
      .catch(error => console.error(`Error loading ${partialName}:`, error));
  }

  $(document).ready(function () {
    loadPartial('_navbar', 'navbar-placeholder');
    loadPartial('_sidebar', 'sidebar');
    loadPartial('_footer', 'footer');

    // setupEventListeners(); // REMOVE this line - setupEventListeners is called from within ProductManager now
    // loadCategories();      // REMOVE this line - loadCategories is called from within ProductManager now
    // loadProducts();        // REMOVE this line - loadProducts is called from within ProductManager now

    // setupImageUpload('addProduct'); // REMOVE these lines - setupImageUpload is called from within ProductManager now
    // setupImageUpload('editProduct'); // REMOVE these lines - setupImageUpload is called from within ProductManager now

    const productManager = new ProductManager(); // Initialize ProductManager which will handle setup
  });

  const apiUrl = 'https://localhost:7203/api/SanPham'; // Adjust the API endpoint if needed
  const categoryApiUrl = 'https://localhost:7203/api/DanhMuc'; // API endpoint for DanhMuc

  class ProductManager {
    constructor() {
      this.currentPage = 1;
      this.pageSize = 10;
      this.searchTerm = '';
      this.categoryFilter = '';
      this.statusFilter = '';
      this.sortBy = '';
      this.sortOrder = 'asc';
      this.productTableBody = document.getElementById('productTableBody');
      this.categoryFilterDropdown = document.getElementById('categoryFilter');
      this.statusFilterDropdown = document.getElementById('statusFilter');
      this.sortByDropdown = document.getElementById('sortBy');
      this.searchInput = document.getElementById('searchInput');
      this.previousPageButton = document.getElementById('previousPage');
      this.nextPageButton = document.getElementById('nextPage');
      this.currentPageSpan = document.getElementById('currentPageNumber');

      this.addProductForm = document.getElementById('addProductForm');
      this.editProductForm = document.getElementById('editProductForm');
      this.viewProductDetails = document.getElementById('viewProductDetails');

      this.addProductImageUpload = this.setupImageUpload('addProduct'); // Assign to class property here
      this.editProductImageUpload = this.setupImageUpload('editProduct'); // Assign to class property here
      this.setupEventListeners(); // Call setupEventListeners from constructor
      this.loadCategories();
      this.loadProducts();


    }


    setupEventListeners() { // Method of the class
      document.querySelector('#addProductModal [data-action="save"]').addEventListener('click', () => this.createProduct());
      document.querySelector('#editProductModal [data-action="update"]').addEventListener('click', () => this.updateProduct());
      document.getElementById('searchButton').addEventListener('click', () => this.handleSearch());
      this.searchInput.addEventListener('input', () => this.handleSearch());
      this.categoryFilterDropdown.addEventListener('change', () => this.applyFiltersAndSorting());
      this.statusFilterDropdown.addEventListener('change', () => this.applyFiltersAndSorting());
      this.sortByDropdown.addEventListener('change', () => this.applyFiltersAndSorting());
      this.previousPageButton.addEventListener('click', () => this.goToPreviousPage());
      this.nextPageButton.addEventListener('click', () => this.goToNextPage());
    }


    async loadProducts() {
      let url = `${apiUrl}?page=${this.currentPage}&pageSize=${this.pageSize}&searchTerm=${this.searchTerm}`;

      if (this.categoryFilter) url += `&maDanhMucFilter=${this.categoryFilter}`;
      if (this.statusFilter) url += `&trangThaiFilter=${this.statusFilter}`;
      if (this.sortBy) url += `&sortBy=${this.sortBy}&sortOrder=${this.sortOrder}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        this.displayProducts(data.items);
        this.updatePaginationControls(data.currentPage, data.totalPages);
      } catch (error) {
        console.error('Không thể tải sản phẩm:', error);
        Swal.fire({ icon: 'error', title: 'Lỗi!', text: 'Không thể tải danh sách sản phẩm.', });
      }
    }

    async loadCategories() {
      try {
        const response = await fetch(categoryApiUrl);
        console.log("Category API Response:", response); // Log the entire response object
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const categories = await response.json();
        console.log("Categories Data:", categories); // Log the parsed categories data
        this.populateCategoryDropdowns(categories); // Call it as a method using 'this'
      } catch (error) {
        console.error('Không thể tải danh mục sản phẩm:', error);
        Swal.fire({
          icon: 'error',
          title: 'Lỗi!',
          text: 'Không thể tải danh mục sản phẩm.',
        });
      }
    }

    populateCategoryDropdowns(categories) { // Method of the class
      const categoryFilterDropdown = document.getElementById('categoryFilter');
      const addCategoryDropdown = document.getElementById('maDanhMuc');
      const editCategoryDropdown = document.getElementById('editMaDanhMuc');

      console.log("Categories received for dropdown population:", categories); // Log categories received

      // Clear existing options first
      categoryFilterDropdown.innerHTML = '<option value="">Tất cả danh mục</option>'; // Keep "Tất cả danh mục" option
      addCategoryDropdown.innerHTML = '<option value="">Chọn danh mục</option>';
      editCategoryDropdown.innerHTML = '<option value="">Chọn danh mục</option>';

      categories.forEach(category => {
        const optionFilter = document.createElement('option');
        optionFilter.value = category.maDanhMuc; // Value is MaDanhMuc
        optionFilter.textContent = category.tenDanhMuc; // Text is TenDanhMuc
        categoryFilterDropdown.appendChild(optionFilter);

        const optionAdd = document.createElement('option');
        optionAdd.value = category.maDanhMuc;
        optionAdd.textContent = category.tenDanhMuc;
        addCategoryDropdown.appendChild(optionAdd);

        const optionEdit = document.createElement('option');
        optionEdit.value = category.maDanhMuc;
        optionEdit.textContent = category.tenDanhMuc;
        editCategoryDropdown.appendChild(optionEdit);
      });
      console.log("Category filter dropdown populated."); // Log after population
    }


    displayProducts(products) {
      this.productTableBody.innerHTML = '';

      products.forEach(product => {
        const row = this.productTableBody.insertRow();
        row.insertCell(0).textContent = product.tenSP;
        row.insertCell(1).innerHTML = product.hinhAnh ? `<img src="${product.hinhAnh}" alt="Hình ảnh sản phẩm" style="max-width: 50px; max-height: 50px;">` : '';
        row.insertCell(2).textContent = product.danhMuc?.tenDanhMuc || 'Không có danh mục';
        row.insertCell(3).textContent = product.nhaCungCap?.tenNCC || 'Không có NCC';
        row.insertCell(4).textContent = product.soLuongTon;
        row.insertCell(5).innerHTML = product.trangThai ? '<label class="badge badge-success">Còn hàng</label>' : '<label class="badge badge-danger">Hết hàng</label>';

        const actionsCell = row.insertCell(6);
        actionsCell.classList.add('text-center');

        const viewButton = this.createActionButton('mdi-eye', 'btn-outline-info', () => this.openViewModal(product.maSP), '#viewProductModal');
        actionsCell.appendChild(viewButton);

        const editButton = this.createActionButton('mdi-pencil', 'btn-outline-primary', () => this.openEditModal(product.maSP), '#editProductModal');
        actionsCell.appendChild(editButton);

        const deleteButton = this.createActionButton('mdi-delete', 'btn-outline-danger', () => this.deleteProduct(product.maSP));
        actionsCell.appendChild(deleteButton);
      });
    }

    createActionButton(iconClass, btnClass, onClickHandler, targetModal = null) {
      const button = document.createElement('button');
      button.innerHTML = `<i class="mdi ${iconClass}"></i>`;
      button.className = `btn btn-sm ${btnClass} mr-2`;
      button.onclick = onClickHandler;
      if (targetModal) {
        button.setAttribute('data-toggle', 'modal');
        button.setAttribute('data-target', targetModal);
      }
      return button;
    }


    async createProduct() {
      const form = document.querySelector('#addProductForm');
      const formData = new FormData(form);
      const productData = Object.fromEntries(formData.entries());
      productData.trangThai = document.querySelector('#addProductModal #trangThai').checked;
      productData.maDanhMuc = document.querySelector('#addProductModal #maDanhMuc').value;
      productData.hinhAnh = this.addProductImageUpload.getImageUrls();

      productData.maSP = this.generateMaSPFrontend();

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData),
        });

        if (response.ok) {
          $('#addProductModal').modal('hide');
          form.reset();
          this.addProductImageUpload.clearPreview();
          this.loadProducts();
          Swal.fire('Thành công!', 'Sản phẩm đã được thêm.', 'success');
        } else if (response.status === 409) {
          Swal.fire('Lỗi!', 'Mã sản phẩm đã tồn tại.', 'error');
        } else {
          throw new Error(`Lỗi HTTP! Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Lỗi thêm sản phẩm:', error);
        Swal.fire('Lỗi!', 'Không thể thêm sản phẩm.', 'error');
      }
    }


    async openEditModal(maSP) {
      try {
        const response = await fetch(`${apiUrl}/${maSP}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const product = await response.json();

        document.querySelector('#editProductModal #editMaSP').value = product.maSP;
        document.querySelector('#editProductModal #editTenSP').value = product.tenSP;
        document.querySelector('#editProductModal #editGiaNhap').value = product.giaNhap;
        document.querySelector('#editProductModal #editGiaBan').value = product.giaBan;
        document.querySelector('#editProductModal #editSoLuongTon').value = product.soLuongTon;
        document.querySelector('#editProductModal #editDonViTinh').value = product.donViTinh;
        document.querySelector('#editProductModal #editTrangThai').checked = product.trangThai;
        document.querySelector('#editProductModal #editMaDanhMuc').value = product.maDanhMuc;

        this.editProductImageUpload.clearPreview();
        if (product.hinhAnh && Array.isArray(product.hinhAnh)) {
          product.hinhAnh.forEach(async imageUrl => {
            if (imageUrl.trim()) {
              try {
                await this.editProductImageUpload.addImagePreviewFromUrl(imageUrl);
              } catch (error) {
                console.error('Lỗi hiển thị preview ảnh cũ:', error);
              }
            }
          });
        }

      } catch (error) {
        console.error('Không thể tải thông tin sản phẩm để chỉnh sửa:', error);
        Swal.fire('Lỗi!', 'Không thể tải thông tin sản phẩm.', 'error');
      }
    }

    async updateProduct() {
      const form = document.querySelector('#editProductForm');
      const formData = new FormData(form);
      const maSP = document.querySelector('#editProductModal #editMaSP').value;
      const productData = Object.fromEntries(formData.entries());
      productData.trangThai = document.querySelector('#editProductModal #editTrangThai').checked;
      productData.maDanhMuc = document.querySelector('#editProductModal #editMaDanhMuc').value;
      productData.hinhAnh = this.editProductImageUpload.getImageUrls();
      productData.maSP = maSP;

      try {
        const response = await fetch(`${apiUrl}/${maSP}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData),
        });

        if (response.ok) {
          $('#editProductModal').modal('hide');
          this.loadProducts();
          Swal.fire('Thành công!', 'Sản phẩm đã được cập nhật.', 'success');
        } else if (response.status === 404) {
          Swal.fire('Lỗi!', 'Không tìm thấy sản phẩm để cập nhật.', 'error');
        } else {
          throw new Error(`Lỗi HTTP! Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Lỗi cập nhật sản phẩm:', error);
        Swal.fire('Lỗi!', 'Không thể cập nhật sản phẩm.', 'error');
      }
    }


    async deleteProduct(maSP) {
      Swal.fire({
        title: 'Bạn có chắc chắn muốn xóa?',
        text: "Bạn sẽ không thể hoàn tác hành động này!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Có, xóa ngay!',
        cancelButtonText: 'Hủy'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`${apiUrl}/${maSP}`, { method: 'DELETE' });
            if (response.ok) {
              this.loadProducts();
              Swal.fire('Đã xóa!', 'Sản phẩm đã được xóa thành công.', 'success');
            } else if (response.status === 404) {
              Swal.fire('Lỗi!', 'Không tìm thấy sản phẩm để xóa.', 'error');
            } else {
              throw new Error(`Lỗi HTTP! Status: ${response.status}`);
            }
          } catch (error) {
            console.error('Lỗi xóa sản phẩm:', error);
            Swal.fire('Lỗi!', 'Không thể xóa sản phẩm.', 'error');
          }
        }
      });
    }

    async openViewModal(maSP) {
      try {
        const response = await fetch(`${apiUrl}/${maSP}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const product = await response.json();
        this.populateViewModal(product);
        $('#viewProductModal').modal('show');
      } catch (error) {
        console.error('Không thể tải thông tin sản phẩm chi tiết:', error);
        Swal.fire('Lỗi!', 'Không thể tải thông tin chi tiết sản phẩm.', 'error');
      }
    }

    populateViewModal(product) {
      this.viewProductDetails.querySelector('[data-product-detail="maSP"]').textContent = product.maSP;
      this.viewProductDetails.querySelector('[data-product-detail="tenSP"]').textContent = product.tenSP;
      this.viewProductDetails.querySelector('[data-product-detail="danhMuc"]').textContent = product.danhMuc?.tenDanhMuc || 'Không có danh mục';
      this.viewProductDetails.querySelector('[data-product-detail="nhaCungCap"]').textContent = product.nhaCungCap?.tenNCC || 'Không có NCC';
      this.viewProductDetails.querySelector('[data-product-detail="giaNhap"]').textContent = this.formatCurrency(product.giaNhap);
      this.viewProductDetails.querySelector('[data-product-detail="giaBan"]').textContent = this.formatCurrency(product.giaBan);
      this.viewProductDetails.querySelector('[data-product-detail="soLuongTon"]').textContent = product.soLuongTon;
      this.viewProductDetails.querySelector('[data-product-detail="donViTinh"]').textContent = product.donViTinh;

      const hinhAnhSpan = this.viewProductDetails.querySelector('[data-product-detail="hinhAnh"]');
      if (product.hinhAnh && product.hinhAnh[0]) { // Use the first image if available. Adjust as needed for multiple images
        hinhAnhSpan.innerHTML = `<img src="${product.hinhAnh[0]}" alt="Hình ảnh sản phẩm" style="max-width: 150px; max-height: 150px;">`;
      } else {
        hinhAnhSpan.textContent = 'Không có hình ảnh';
      }
    }


    formatCurrency(number) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
    }

    updatePaginationControls(currentPage, totalPages) {
      this.currentPageSpan.textContent = currentPage;

      if (currentPage <= 1) {
        this.previousPageButton.classList.add('disabled');
      } else {
        this.previousPageButton.classList.remove('disabled');
      }

      if (currentPage >= totalPages) {
        this.nextPageButton.classList.add('disabled');
      } else {
        this.nextPageButton.classList.remove('disabled');
      }
    }

    goToPreviousPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        this.loadProducts();
      }
    }

    goToNextPage() {
      if (!this.nextPageButton.classList.contains('disabled')) {
        this.currentPage++;
        this.loadProducts();
      }
    }

    handleSearch() {
      this.searchTerm = this.searchInput.value;
      this.currentPage = 1;
      this.loadProducts();
    }

    applyFiltersAndSorting() {
      this.categoryFilter = this.categoryFilterDropdown.value;
      this.statusFilter = this.statusFilterDropdown.value;
      const selectedSortOption = this.sortByDropdown.value;

      if (selectedSortOption === 'TenSP_asc') {
        this.sortBy = 'TenSP';
        this.sortOrder = 'asc';
      } else if (selectedSortOption === 'TenSP_desc') {
        this.sortBy = 'TenSP';
        this.sortOrder = 'desc';
      } else {
        this.sortBy = '';
        this.sortOrder = 'asc'; // Default sorting
      }

      this.currentPage = 1;
      this.loadProducts();
    }


    setupImageUpload(modalPrefix) { // Method of the class
      const uploadArea = document.getElementById(`${modalPrefix}ImageUploadArea`);
      const fileInput = document.getElementById(`${modalPrefix}ImageFile`);
      const previewContainer = document.getElementById(`${modalPrefix}ImagePreview`);
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      let imageUrls = []; // Store image URLs for this upload instance

      const createImagePreview = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const imageUrl = event.target.result;
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';

            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            imageUrls.push(imageUrl); // Add to imageUrls array
            previewDiv.appendChild(imgElement);

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-image-button';
            removeButton.innerHTML = '×';
            removeButton.onclick = function () {
              const index = imageUrls.indexOf(imageUrl);
              if (index > -1) {
                imageUrls.splice(index, 1); // Remove from imageUrls array
              }
              previewDiv.remove();
            };
            previewDiv.appendChild(removeButton);

            resolve(previewDiv);
          }
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };


      const handleFiles = async (files) => {
        for (const file of files) {
          if (!allowedTypes.includes(file.type)) {
            Swal.fire('Lỗi!', 'Loại file không hợp lệ. Chỉ chấp nhận file hình ảnh.', 'error');
            continue;
          }
          try {
            const previewElement = await createImagePreview(file);
            previewContainer.appendChild(previewElement);
          } catch (error) {
            console.error('Lỗi tạo preview ảnh:', error);
            Swal.fire('Lỗi!', 'Không thể tạo preview ảnh.', 'error');
          }
        }
      };

      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('highlight'); });
      uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('highlight'); });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault(); uploadArea.classList.remove('highlight');
        handleFiles(e.dataTransfer.files);
      });
      uploadArea.querySelector('.btn-upload-image').addEventListener('click', () => { fileInput.click(); });
      fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); fileInput.value = ''; });

      return { // Return an object to manage image upload state and actions
        getImageUrls: () => imageUrls,
        clearPreview: () => { previewContainer.innerHTML = ''; imageUrls = []; },
        addImagePreviewFromUrl: async (url) => {
          return new Promise((resolve, reject) => {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            const imgElement = document.createElement('img');
            imgElement.src = url;
            imageUrls.push(url); // Add to imageUrls array
            previewDiv.appendChild(imgElement);

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-image-button';
            removeButton.innerHTML = '×';
            removeButton.onclick = function () {
              const index = imageUrls.indexOf(url);
              if (index > -1) {
                imageUrls.splice(index, 1); // Remove from imageUrls array
              }
              previewDiv.remove();
            };
            previewDiv.appendChild(removeButton);
            previewContainer.appendChild(previewDiv);
            resolve();
          });
        }
      };
    }


    generateMaSPFrontend() {
      const prefix = "SP";
      const randomNumber = Math.floor(Math.random() * 1000);
      const formattedNumber = randomNumber.toString().padStart(3, '0');
      return prefix + formattedNumber;
    }
  }

  const productManager = new ProductManager();
</script>

</body>

</html>