<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Quản lý Sản phẩm</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="../../assets/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="../../assets/vendors/font-awesome/css/font-awesome.min.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <link rel="stylesheet" href="../../assets/css/style.css">
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="../../assets/css/style.css">
  <!-- End layout styles -->
  <link rel="shortcut icon" href="../../assets/images/favicon.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
  <style>
    .table-responsive {
      overflow-x: auto;
      /* Enable horizontal scroll for small screens */
    }

    .table th,
    .table td {
      white-space: nowrap;
      /* Prevent text wrapping in table cells */
    }

    .drop-area {
      border: 2px dashed #ccc;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .drop-area.highlight {
      border-color: #007bff;
      /* Màu khi kéo file vào */
    }

    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      /* Cho phép preview xuống hàng khi nhiều ảnh */
    }

    .image-preview {
      position: relative;
      /* Cần thiết để định vị nút xóa */
      margin: 5px;
    }

    .image-preview img {
      max-width: 100px;
      /* Kích thước preview */
      max-height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      object-fit: cover;
      /* Đảm bảo ảnh không bị méo */
    }

    .remove-image-button {
      position: absolute;
      /* Định vị nút xóa ở góc trên phải preview */
      top: -5px;
      right: -5px;
      background-color: rgba(255, 0, 0, 0.7);
      /* Nền đỏ mờ */
      color: white;
      border: none;
      border-radius: 50%;
      /* Hình tròn */
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      /* Ẩn nút xóa ban đầu */
      transition: opacity 0.2s ease-in-out;
      /* Hiệu ứng fade in/out */
    }

    .image-preview:hover .remove-image-button {
      opacity: 1;
      /* Hiện nút xóa khi hover vào preview */
    }
  </style>
</head>

<body>
  <div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row" id="navbar-placeholder">
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_sidebar.html -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar"></nav>
      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title"> Quản lý Sản phẩm </h3>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Sản phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page">Danh sách sản phẩm</li>
              </ol>
            </nav>
          </div>
          <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Danh sách Sản phẩm</h4>
                  <div class="row mb-3">
                    <div class="col-md-12 mb-3">
                      <div class="row">
                        <!-- Category Filter -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="categoryFilter">Danh mục</label>
                            <select class="form-control" id="categoryFilter" name="categoryFilter">
                              <option value="">Tất cả danh mục</option>
                              <!-- Categories will be loaded here -->
                            </select>
                          </div>
                        </div>
                        <!-- Status Filter -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="statusFilter">Trạng thái</label>
                            <select class="form-control" id="statusFilter">
                              <option value="">Tất cả trạng thái</option>
                              <option value="true">Còn hàng</option>
                              <option value="false">Hết hàng</option>
                            </select>
                          </div>
                        </div>
                        <!-- Sorting Dropdown -->
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="sortBy">Sắp xếp theo</label>
                            <select class="form-control" id="sortBy">
                              <option value="">Mặc định</option>
                              <option value="TenSP_asc">Tên SP (A-Z)</option>
                              <option value="TenSP_desc">Tên SP (Z-A)</option>
                              <!-- Add more sorting options here if needed -->
                            </select>
                          </div>
                        </div>

                      </div>
                    </div>
                    <div class="col-md-6 text-left">
                      <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm sản phẩm..."
                          aria-label="Tìm kiếm sản phẩm">
                        <div class="input-group-append">
                          <button class="btn btn-sm btn-primary" type="button" id="searchButton">Tìm kiếm</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 text-md-right">
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addProductModal">
                        <i class="mdi mdi-plus-circle-outline"></i> Thêm Sản phẩm
                      </button>
                    </div>
                  </div>

                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Tên Sản phẩm</th>
                          <th>Hình Ảnh</th>
                          <th>Danh mục</th>
                          <th>Nhà cung cấp</th>
                          <th>Số Lượng Tồn</th>
                          <th>Trạng Thái</th>
                          <th>Thao tác</th> <!-- Vẫn giữ cột thao tác -->
                        </tr>
                      </thead>
                      <tbody id="productTableBody">
                        <!-- Product rows will be inserted here by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <div class="mt-3 d-flex justify-content-center">
                    <nav aria-label="Product pagination">
                      <ul class="pagination">
                        <li class="page-item" id="previousPage">
                          <button class="page-link" aria-label="Previous">
                            <span aria-hidden="true">«</span>
                            <span class="sr-only">Previous</span>
                          </button>
                        </li>
                        <li class="page-item disabled"><span class="page-link" id="currentPageNumber">1</span></li>
                        <li class="page-item" id="nextPage">
                          <button class="page-link" aria-label="Next">
                            <span aria-hidden="true">»</span>
                            <span class="sr-only">Next</span>
                          </button>
                        </li>
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->

        <!--  Add Product Modal -->
        <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel"
          aria-hidden="true">
          <div class="modal-dialog " role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Thêm Sản phẩm mới</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="addProductForm">
                  <div class="form-group">
                    <!-- <label for="maSP">Mã Sản Phẩm</label> -->
                    <input type="hidden" class="form-control" id="maSP" name="maSP">
                  </div>
                  <div class="form-group">
                    <label for="tenSP">Tên Sản Phẩm</label>
                    <input type="text" class="form-control" id="tenSP" name="tenSP" required>
                  </div>
                  <div class="form-group">
                    <label for="giaNhap">Giá Nhập</label>
                    <input type="number" class="form-control" id="giaNhap" name="giaNhap" min="0" step="1" required>
                  </div>
                  <div class="form-group">
                    <label for="giaBan">Giá Bán</label>
                    <input type="number" class="form-control" id="giaBan" name="giaBan" min="0" step="1" required>
                  </div>
                  <div class="form-group">
                    <label for="soLuongTon">Số Lượng Tồn</label>
                    <input type="number" class="form-control" id="soLuongTon" name="soLuongTon" min="0" required>
                  </div>
                  <div class="form-group">
                    <label for="donViTinh">Đơn Vị Tính</label>
                    <input type="text" class="form-control" id="donViTinh" name="donViTinh">
                  </div>
                  <div class="form-group">
                    <label>Hình Ảnh Sản Phẩm</label>
                    <div id="addProductImageUploadArea" class="drop-area">
                      <p>Kéo và thả hình ảnh vào đây hoặc</p>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-upload-image">Chọn hình ảnh từ
                        máy tính</button>
                      <input type="file" id="addProductImageFile" name="hinhAnhFiles" multiple style="display:none;"
                        accept="image/*">
                    </div>
                    <div id="addProductImagePreview" class="image-preview-container">
                      <!-- Hình ảnh preview sẽ được hiển thị ở đây -->
                    </div>
                  </div>
              </div>
              <div class="form-group">
                <label for="maDanhMuc">Danh mục sản phẩm</label>
                <select class="form-control" id="maDanhMuc" name="maDanhMuc" required>
                  <option value="">Chọn danh mục</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
              <div class="form-check form-check-primary">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="trangThai" name="trangThai" checked>
                  Còn hàng <i class="input-helper"></i>
                </label>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveProductButton">Lưu Sản phẩm</button>
              </div>
              </form>
            </div>

          </div>
        </div>


        <!-- Edit Product Modal -->
        <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog"
          aria-labelledby="editProductModalLabel" aria-hidden="true">
          <div class="modal-dialog " role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Chỉnh sửa Sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="editProductForm">
                  <input type="hidden" id="editMaSP" name="maSP">
                  <div class="form-group">
                    <label for="editTenSP">Tên Sản Phẩm</label>
                    <input type="text" class="form-control" id="editTenSP" name="tenSP" required>
                  </div>
                  <div class="form-group">
                    <label for="editGiaNhap">Giá Nhập</label>
                    <input type="number" class="form-control" id="editGiaNhap" name="giaNhap" min="0" step="0.01"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="editGiaBan">Giá Bán</label>
                    <input type="number" class="form-control" id="editGiaBan" name="giaBan" min="0" step="0.01"
                      required>
                  </div>
                  <div class="form-group">
                    <label for="editSoLuongTon">Số Lượng Tồn</label>
                    <input type="number" class="form-control" id="editSoLuongTon" name="soLuongTon" min="0" required>
                  </div>
                  <div class="form-group">
                    <label for="editDonViTinh">Đơn Vị Tính</label>
                    <input type="text" class="form-control" id="editDonViTinh" name="donViTinh">
                  </div>
                  <div class="form-group">
                    <label>Hình Ảnh Sản Phẩm</label>
                    <div id="editProductImageUploadArea" class="drop-area">
                      <p>Kéo và thả hình ảnh vào đây hoặc</p>
                      <button type="button" class="btn btn-sm btn-outline-secondary btn-upload-image">Chọn hình ảnh từ
                        máy
                        tính</button>
                      <input type="file" id="editProductImageFile" name="hinhAnhFiles" multiple style="display:none;"
                        accept="image/*">
                    </div>
                    <div id="editProductImagePreview" class="image-preview-container">
                      <!-- Hình ảnh preview sẽ được hiển thị ở đây -->
                    </div>
                  </div>
              </div>
              <div class="form-group">
                <label for="editMaDanhMuc">Danh mục sản phẩm</label>
                <select class="form-control" id="editMaDanhMuc" name="maDanhMuc" required>
                  <option value="">Chọn danh mục</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
              <div class="form-check form-check-primary">
                <label class="form-check-label">
                  <input type="checkbox" class="form-check-input" id="editTrangThai" name="trangThai">
                  Còn hàng <i class="input-helper"></i>
                </label>
              </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
              <button type="button" class="btn btn-primary" id="updateProductButton">Lưu Thay Đổi</button>
            </div>
          </div>
        </div>


        <!-- View Product Modal -->
        <div class="modal fade" id="viewProductModal" tabindex="-1" role="dialog"
          aria-labelledby="viewProductModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document"> <!-- modal-lg để modal rộng hơn -->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="viewProductModalLabel">Chi tiết Sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Mã Sản Phẩm:</strong> <span id="viewMaSP"></span></p>
                    <p><strong>Tên Sản Phẩm:</strong> <span id="viewTenSP"></span></p>
                    <p><strong>Danh mục:</strong> <span id="viewDanhMuc"></span></p>
                    <p><strong>Nhà cung cấp:</strong> <span id="viewNhaCungCap"></span></p>
                    <p><strong>Đơn Vị Tính:</strong> <span id="viewDonViTinh"></span></p>
                    <p><strong>Trạng Thái:</strong> <span id="viewTrangThai"></span></p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Giá Nhập:</strong> <span id="viewGiaNhap"></span></p>
                    <p><strong>Giá Bán:</strong> <span id="viewGiaBan"></span></p>
                    <p><strong>Số Lượng Tồn:</strong> <span id="viewSoLuongTon"></span></p>
                    <p><strong>Hình Ảnh:</strong> <span id="viewHinhAnh"></span></p>
                  </div>
                </div>
                <!-- Thêm các trường thông tin chi tiết khác nếu cần -->
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
              </div>
            </div>
          </div>
        </div>
      </div>



      <!-- content-wrapper ends -->
      <!-- partial:partials/_footer.html -->
      <footer class="footer" id="footer"></footer>
      <!-- partial -->
    </div>
    <!-- main-panel ends -->
  </div>
  <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <!-- plugins:js -->
  <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="../../assets/js/off-canvas.js"></script>
  <script src="../../assets/js/misc.js"></script>
  <script src="../../assets/js/settings.js"></script>
  <script src="../../assets/js/todolist.js"></script>
  <script src="../../assets/js/jquery.cookie.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <!-- End custom js for this page -->
  <!-- Bootstrap Modal JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    // Function to load partial HTML content using Fetch API
    function loadPartial(partialName, elementId) {
      fetch(`/Admin/src/partials/${partialName}.html`) // Adjust path if needed
        .then(response => response.text())
        .then(data => {
          document.getElementById(elementId).innerHTML = data;
        })
        .catch(error => console.error(`Error loading ${partialName}:`, error));
    }

    $(document).ready(function () {
      loadPartial('_navbar', 'navbar-placeholder');
      loadPartial('_sidebar', 'sidebar');
      loadPartial('_footer', 'footer');
    });
  </script>

  <script>
    const apiUrl = 'https://localhost:7203/api/SanPham'; // Adjust the API endpoint if needed
    const categoryApiUrl = 'https://localhost:7203/api/DanhMuc'; // API endpoint for DanhMuc

    let currentPage = 1;
    const pageSize = 10; // You can adjust page size here
    let searchTerm = '';

    document.addEventListener('DOMContentLoaded', function () {
      loadProducts();
      loadCategories(); // Load categories on page load

      document.getElementById('saveProductButton').addEventListener('click', createProduct);
      document.getElementById('updateProductButton').addEventListener('click', updateProduct);
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      document.getElementById('searchInput').addEventListener('input', handleSearch);
      document.getElementById('categoryFilter').addEventListener('change', applyFiltersAndSorting);
      document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSorting);
      document.getElementById('sortBy').addEventListener('change', applyFiltersAndSorting); // Changed to 'input' event for real-time search
      // document.getElementById('searchInput').addEventListener('keypress', function (e) { // Commented out keypress listener
      //   if (e.key === 'Enter') {
      //     handleSearch();
      //   }
      // });
      document.getElementById('previousPage').addEventListener('click', goToPreviousPage);
      document.getElementById('nextPage').addEventListener('click', goToNextPage);

      setupImageUpload('addProduct');
      setupImageUpload('editProduct');
    });

    async function loadProducts() {
      const categoryFilter = document.getElementById('categoryFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const sortByElement = document.getElementById('sortBy');
      const selectedSortOption = sortByElement.value;
      let sortBy = '';
      let sortOrder = 'asc'; // Default sort order

      if (selectedSortOption === 'TenSP_asc') {
        sortBy = 'TenSP';
        sortOrder = 'asc';
      } else if (selectedSortOption === 'TenSP_desc') {
        sortBy = 'TenSP';
        sortOrder = 'desc';
      }


      let url = `${apiUrl}?page=${currentPage}&pageSize=${pageSize}&searchTerm=${searchTerm}`;

      if (categoryFilter) url += `&maDanhMucFilter=${categoryFilter}`;
      if (statusFilter) url += `&trangThaiFilter=${statusFilter}`;
      if (sortBy) url += `&sortBy=${sortBy}&sortOrder=${sortOrder}`;


      try {
        const response = await fetch(url);
        console.log("Raw API Response (loadProducts):", response);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log("Parsed Products Data (loadProducts):", data);
        displayProducts(data.items.$values);
        updatePaginationControls(data.currentPage, data.totalPages);
      } catch (error) {
        console.error('Không thể tải sản phẩm:', error);
        Swal.fire({
          icon: 'error',
          title: 'Lỗi!',
          text: 'Không thể tải danh sách sản phẩm.',
        });
      }
    }

    async function loadCategories() {
      try {
        const response = await fetch(categoryApiUrl);
        console.log("Raw API Response (loadCategories):", response); // Log the raw response object
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const categories = await response.json();
        console.log("Parsed Categories Data (loadCategories):", categories); // Log the parsed data
        populateCategoryDropdowns(categories);
      } catch (error) {
        console.error('Không thể tải danh mục sản phẩm:', error);
        Swal.fire({
          icon: 'error',
          title: 'Lỗi!',
          text: 'Không thể tải danh mục sản phẩm.',
        });
      }
    }

    function populateCategoryDropdowns(categories) {
      const addCategoryDropdown = document.getElementById('maDanhMuc');
      const editCategoryDropdown = document.getElementById('editMaDanhMuc');

      // Clear existing options first
      addCategoryDropdown.innerHTML = '<option value="">Chọn danh mục</option>';
      editCategoryDropdown.innerHTML = '<option value="">Chọn danh mục</option>';

      // Lặp qua mảng categories bên trong thuộc tính $values
      categories.$values.forEach(category => {
        const optionAdd = document.createElement('option');
        optionAdd.value = category.maDanhMuc;
        optionAdd.textContent = category.tenDanhMuc;
        addCategoryDropdown.appendChild(optionAdd);

        const optionEdit = document.createElement('option');
        optionEdit.value = category.maDanhMuc;
        optionEdit.textContent = category.tenDanhMuc;
        editCategoryDropdown.appendChild(optionEdit);
      });
    }


    function displayProducts(products) {
      const tableBody = document.getElementById('productTableBody');
      tableBody.innerHTML = ''; // Clear existing table rows

      products.forEach(product => {
        const row = tableBody.insertRow();

        // Tên sản phẩm
        row.insertCell(0).textContent = product.tenSP;

        // Hình ảnh
        row.insertCell(1).innerHTML = product.hinhAnh ? `<img src="${product.hinhAnh}" alt="Hình ảnh sản phẩm" style="max-width: 50px; max-height: 50px;">` : '';

        // Danh mục
        row.insertCell(2).textContent = product.danhMuc?.tenDanhMuc || 'Không có danh mục';

        // Nhà cung cấp (cần đảm bảo API trả về thông tin nhà cung cấp, có thể cần include NhaCungCap trong backend controller)
        row.insertCell(3).textContent = product.nhaCungCap?.tenNCC || 'Không có NCC';

        // Số lượng tồn
        row.insertCell(4).textContent = product.soLuongTon;

        // Trạng thái
        row.insertCell(5).innerHTML = product.trangThai ? '<label class="badge badge-success">Còn hàng</label>' : '<label class="badge badge-danger">Hết hàng</label>';

        // Action buttons cell (cột Thao tác)
        const actionsCell = row.insertCell(6); // Cột "Thao tác" giờ là cột thứ 8 (index 7)
        actionsCell.classList.add('text-center');

        // **Nút "Xem chi tiết" (Thêm vào ĐÂY)**
        const viewButton = document.createElement('button');
        viewButton.innerHTML = '<i class="mdi mdi-eye"></i>'; // Chỉ icon mắt, hoặc bạn có thể thêm chữ nếu muốn
        viewButton.className = 'btn btn-sm btn-outline-info mr-2'; // Thêm class mr-2 để tạo khoảng cách bên phải
        viewButton.setAttribute('data-toggle', 'modal');
        viewButton.setAttribute('data-target', '#viewProductModal');
        viewButton.onclick = () => openViewModal(product.maSP);
        actionsCell.appendChild(viewButton);


        // Nút "Chỉnh sửa" (Code cũ - không thay đổi)
        const editButton = document.createElement('button');
        editButton.innerHTML = '<i class="mdi mdi-pencil"></i>';
        editButton.className = 'btn btn-sm btn-outline-primary mr-2'; // Vẫn giữ class mr-2 để tạo khoảng cách
        editButton.setAttribute('data-toggle', 'modal');
        editButton.setAttribute('data-target', '#editProductModal');
        editButton.onclick = () => openEditModal(product.maSP);
        actionsCell.appendChild(editButton);

        // Nút "Xóa" (Code cũ - không thay đổi)
        const deleteButton = document.createElement('button');
        deleteButton.innerHTML = '<i class="mdi mdi-delete"></i>';
        deleteButton.className = 'btn btn-sm btn-outline-danger';
        deleteButton.onclick = () => deleteProduct(product.maSP);
        actionsCell.appendChild(deleteButton);
      });
    }

    async function createProduct() {
      const form = document.getElementById('addProductForm');

      const maSPMoi = generateMaSPFrontend();
      document.getElementById('maSP').value = maSPMoi;

      const formData = new FormData(form);
      const productData = {};
      formData.forEach((value, key) => {
        if (key === 'trangThai') {
          productData[key] = document.getElementById('trangThai').checked;
        } else {
          productData[key] = value;
        }
      });

      productData.maDanhMuc = document.getElementById('maDanhMuc').value;

      console.log('productData trước fetch:', productData);


      // **Lấy danh sách URLs hình ảnh từ preview container**
      const imagePreviewContainer = document.getElementById('addProductImagePreview');
      const imageElements = imagePreviewContainer.querySelectorAll('img');
      const imageUrls = Array.from(imageElements).map(img => img.src);
      productData.hinhAnh = imageUrls; // **GÁN MẢNG imageUrls TRỰC TIẾP**


      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(productData),
        });

        if (response.ok) {
          $('#addProductModal').modal('hide'); // Close the modal
          form.reset(); // Reset the form
          loadProducts(); // Reload product list
          Swal.fire('Thành công!', 'Sản phẩm đã được thêm.', 'success');
        } else if (response.status === 409) {
          Swal.fire('Lỗi!', 'Mã sản phẩm đã tồn tại.', 'error');
        }
        else {
          throw new Error(`Lỗi HTTP! Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Lỗi thêm sản phẩm:', error);
        Swal.fire('Lỗi!', 'Không thể thêm sản phẩm.', 'error');
      }
    }

    async function openEditModal(maSP) {
      try {
        const response = await fetch(`${apiUrl}/${maSP}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const product = await response.json();
        // Populate the edit modal form with product details
        document.getElementById('editMaSP').value = product.maSP;
        document.getElementById('editTenSP').value = product.tenSP;
        document.getElementById('editGiaNhap').value = product.giaNhap;
        document.getElementById('editGiaBan').value = product.giaBan;
        document.getElementById('editSoLuongTon').value = product.soLuongTon;
        document.getElementById('editDonViTinh').value = product.donViTinh;
        document.getElementById('editHinhAnh').value = product.hinhAnh;
        document.getElementById('editTrangThai').checked = product.trangThai;

        // Select the correct category in the edit dropdown
        document.getElementById('editMaDanhMuc').value = product.maDanhMuc;
        const editImagePreviewContainer = document.getElementById('editProductImagePreview');
        editImagePreviewContainer.innerHTML = ''; // Clear preview container trước khi hiển thị ảnh mới

        if (product.hinhAnh && Array.isArray(product.hinhAnh)) { // **KIỂM TRA product.hinhAnh LÀ MẢNG**
          const imageUrls = product.hinhAnh; // **GIỜ product.hinhAnh LÀ MẢNG TRỰC TIẾP**
          imageUrls.forEach(async imageUrl => {
            if (imageUrl.trim()) { // Kiểm tra URL không rỗng
              try {
                const previewElement = await createImagePreview({ type: 'image', result: imageUrl }); // Tạo preview từ URL
                previewElement.querySelector('img').src = imageUrl; // Set src cho img element
                editImagePreviewContainer.appendChild(previewElement); // Thêm preview vào container
              } catch (error) {
                console.error('Lỗi hiển thị preview ảnh cũ:', error);
              }
            }
          });
        }
      } catch (error) {
        console.error('Không thể tải thông tin sản phẩm để chỉnh sửa:', error);
        Swal.fire('Lỗi!', 'Không thể tải thông tin sản phẩm.', 'error');
      }
    }

    async function updateProduct() {
      const form = document.getElementById('editProductForm');
      const formData = new FormData(form);
      const maSP = document.getElementById('editMaSP').value;
      const productData = {};
      formData.forEach((value, key) => {
        if (key === 'trangThai') {
          productData[key] = document.getElementById('editTrangThai').checked;
        } else {
          productData[key] = value;
        }
      });
      productData.maSP = maSP;
      productData.maDanhMuc = document.getElementById('editMaDanhMuc').value;

      // **Lấy danh sách URLs hình ảnh từ preview container (KHÔNG join thành chuỗi nữa)**
      const imagePreviewContainer = document.getElementById('editProductImagePreview');
      const imageElements = imagePreviewContainer.querySelectorAll('img');
      const imageUrls = Array.from(imageElements).map(img => img.src);
      productData.hinhAnh = imageUrls; // **GÁN MẢNG imageUrls TRỰC TIẾP**


      try {
        const response = await fetch(`${apiUrl}/${maSP}`, { // Use MaSP in the PUT request URL
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(productData),
        });

        if (response.ok) {
          $('#editProductModal').modal('hide'); // Close the modal
          loadProducts(); // Reload product list
          Swal.fire('Thành công!', 'Sản phẩm đã được cập nhật.', 'success');
        } else if (response.status === 404) {
          Swal.fire('Lỗi!', 'Không tìm thấy sản phẩm để cập nhật.', 'error');
        }
        else {
          throw new Error(`Lỗi HTTP! Status: ${response.status}`);
        }
      } catch (error) {
        console.error('Lỗi cập nhật sản phẩm:', error);
        Swal.fire('Lỗi!', 'Không thể cập nhật sản phẩm.', 'error');
      }
    }


    async function deleteProduct(maSP) {
      Swal.fire({
        title: 'Bạn có chắc chắn muốn xóa?',
        text: "Bạn sẽ không thể hoàn tác hành động này!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Có, xóa ngay!',
        cancelButtonText: 'Hủy'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const response = await fetch(`${apiUrl}/${maSP}`, {
              method: 'DELETE',
            });
            if (response.ok) {
              loadProducts(); // Reload product list
              Swal.fire(
                'Đã xóa!',
                'Sản phẩm đã được xóa thành công.',
                'success'
              );
            } else if (response.status === 404) {
              Swal.fire('Lỗi!', 'Không tìm thấy sản phẩm để xóa.', 'error');
            }
            else {
              throw new Error(`Lỗi HTTP! Status: ${response.status}`);
            }
          } catch (error) {
            console.error('Lỗi xóa sản phẩm:', error);
            Swal.fire('Lỗi!', 'Không thể xóa sản phẩm.', 'error');
          }
        }
      })
    }

    async function openViewModal(maSP) {
      try {
        const response = await fetch(`${apiUrl}/${maSP}`); // Gọi API GET theo MaSP
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const product = await response.json();
        console.log("Product details for view:", product); // Log chi tiết sản phẩm

        // Điền dữ liệu sản phẩm vào modal
        document.getElementById('viewMaSP').textContent = product.maSP;
        document.getElementById('viewTenSP').textContent = product.tenSP;
        document.getElementById('viewDanhMuc').textContent = product.danhMuc?.tenDanhMuc || 'Không có danh mục';
        document.getElementById('viewNhaCungCap').textContent = product.nhaCungCap?.tenNCC || 'Không có NCC';
        document.getElementById('viewGiaNhap').textContent = formatCurrency(product.giaNhap);
        document.getElementById('viewGiaBan').textContent = formatCurrency(product.giaBan);
        document.getElementById('viewSoLuongTon').textContent = product.soLuongTon;
        document.getElementById('viewDonViTinh').textContent = product.donViTinh;

        const viewHinhAnhSpan = document.getElementById('viewHinhAnh');
        if (product.hinhAnh) {
          viewHinhAnhSpan.innerHTML = `<img src="${product.hinhAnh}" alt="Hình ảnh sản phẩm" style="max-width: 150px; max-height: 150px;">`; // Hiển thị ảnh nếu có
        } else {
          viewHinhAnhSpan.textContent = 'Không có hình ảnh'; // Hiển thị text nếu không có ảnh
          viewHinhAnhSpan.innerHTML = ''; // Hoặc xóa nội dung nếu muốn để trống
        }


        $('#viewProductModal').modal('show'); // Hiển thị modal "Xem chi tiết"

      } catch (error) {
        console.error('Không thể tải thông tin sản phẩm chi tiết:', error);
        Swal.fire('Lỗi!', 'Không thể tải thông tin chi tiết sản phẩm.', 'error');
      }
    }

    function formatCurrency(number) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(number);
    }

    function updatePaginationControls(currentPage, totalPages) {
      document.getElementById('currentPageNumber').textContent = currentPage;

      const previousButton = document.getElementById('previousPage');
      const nextButton = document.getElementById('nextPage');

      if (currentPage <= 1) {
        previousButton.classList.add('disabled');
      } else {
        previousButton.classList.remove('disabled');
      }

      if (currentPage >= totalPages) {
        nextButton.classList.add('disabled');
      } else {
        nextButton.classList.remove('disabled');
      }
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        loadProducts();
      }
    }

    function goToNextPage() {
      const nextButton = document.getElementById('nextPage');
      if (!nextButton.classList.contains('disabled')) {
        currentPage++;
        loadProducts();
      }
    }

    function handleSearch() {
      searchTerm = document.getElementById('searchInput').value;
      currentPage = 1;
      loadProducts();
    }

    function applyFiltersAndSorting() {
      currentPage = 1; // Reset to page 1 when filters/sorting change
      loadProducts();
    }

    function setupImageUpload(modalPrefix) {
      const uploadArea = document.getElementById(`${modalPrefix}ImageUploadArea`);
      const fileInput = document.getElementById(`${modalPrefix}ImageFile`);
      const previewContainer = document.getElementById(`${modalPrefix}ImagePreview`);
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']; // Các loại file ảnh cho phép

      // Hàm tạo preview image element
      const createImagePreview = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const imageUrl = event.target.result;
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';

            const imgElement = document.createElement('img');
            imgElement.src = imageUrl;
            previewDiv.appendChild(imgElement);

            const removeButton = document.createElement('button');
            removeButton.className = 'remove-image-button';
            removeButton.innerHTML = '×'; // Dấu nhân (X)
            removeButton.onclick = function () {
              previewDiv.remove(); // Xóa preview khi click nút xóa
            };
            previewDiv.appendChild(removeButton);

            resolve(previewDiv);
          }
          reader.onerror = reject;
          reader.readAsDataURL(file); // Đọc file và chuyển thành Data URL
        });
      };


      // Hàm xử lý files (từ input file hoặc kéo thả)
      const handleFiles = async (files) => {
        for (const file of files) {
          if (!allowedTypes.includes(file.type)) {
            Swal.fire('Lỗi!', 'Loại file không hợp lệ. Chỉ chấp nhận file hình ảnh.', 'error');
            continue; // Bỏ qua file không hợp lệ
          }
          try {
            const previewElement = await createImagePreview(file);
            previewContainer.appendChild(previewElement); // Thêm preview vào container
          } catch (error) {
            console.error('Lỗi tạo preview ảnh:', error);
            Swal.fire('Lỗi!', 'Không thể tạo preview ảnh.', 'error');
          }
        }
      };


      // **Drag and Drop Events**
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('highlight'); // Thêm class highlight khi kéo vào
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('highlight'); // Xóa class highlight khi kéo ra
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('highlight'); // Xóa class highlight sau khi thả

        const files = e.dataTransfer.files; // Lấy danh sách files từ sự kiện drop
        handleFiles(files); // Gọi hàm xử lý files
      });


      // **Click nút "Chọn hình ảnh từ máy tính"**
      uploadArea.querySelector('.btn-upload-image').addEventListener('click', () => {
        fileInput.click(); // Kích hoạt input type="file" khi click nút
      });


      // **Event 'change' của input type="file"**
      fileInput.addEventListener('change', (e) => {
        const files = e.target.files; // Lấy danh sách files từ input file
        handleFiles(files); // Gọi hàm xử lý files
        fileInput.value = ''; // Reset input file để có thể chọn lại cùng file
      });
    }

    function generateMaSPFrontend() {
      const prefix = "SP";
      // You might want to fetch the latest MaSP from the API here to ensure uniqueness,
      // but for simplicity, we'll generate a random number and format it.
      const randomNumber = Math.floor(Math.random() * 1000); // Generate a random number (0-999)
      const formattedNumber = randomNumber.toString().padStart(3, '0'); // Pad with leading zeros to 3 digits
      return prefix + formattedNumber; // e.g., "SP001", "SP099", "SP999"
    }

  </script>

</body>

</html>