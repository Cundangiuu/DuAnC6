<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Trang chủ Admin</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="../../assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="../../assets/images/favicon.png" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
</head>

<body>
    <div class="container-scroller">
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row"
            id="navbar-placeholder"></nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar"></nav>
            <!-- partial -->
            <div class="main-panel" style="font-family: 'Times New Roman', Times, serif;">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">Quản lý Nhà Cung Cấp</h3>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#">Quản lý</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Nhà Cung Cấp</li>
                            </ol>
                        </nav>
                    </div>
                    <!-- Tìm kiếm và sắp xếp -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Tìm kiếm:</label>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Nhập tên, email, địa chỉ...">
                        </div>
                        <div class="col-md-4">
                            <label for="sortSelect" class="form-label">Sắp xếp theo:</label>
                            <select class="form-select" id="sortSelect"
                                style="font-family: 'Times New Roman', Times, serif;">
                                <option value="">Mặc định</option>
                                <option value="mancc">Mã nhà cung cấp</option>
                                <option value="tenncc">Tên nhà cung cấp</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="sortOrderSelect" class="form-label">Thứ tự:</label>
                            <select class="form-select" id="sortOrderSelect"
                                style="font-family: 'Times New Roman', Times, serif;">
                                <option value="asc">Tăng dần</option>
                                <option value="desc">Giảm dần</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title" style="font-family: 'Times New Roman', Times, serif;">Danh sách
                                        Nhà Cung Cấp</h4>
                                    <p class="card-description" style="font-family: 'Times New Roman', Times, serif;">
                                        Quản lý thông tin nhà cung cấp
                                    </p>
                                    <!-- Nút thêm nhà cung cấp -->
                                    <button class="btn btn-primary mb-3" id="btnAddNhaCungCap"
                                        style="font-family: 'Times New Roman', Times, serif;"><i
                                            class="mdi mdi-plus-circle-outline"></i> Thêm Nhà Cung Cấp</button>

                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Mã Nhà Cung
                                                        Cấp</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Tên Nhà Cung
                                                        Cấp</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Số Điện
                                                        Thoại</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Email</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Địa Chỉ
                                                    </th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Hành động
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                <!-- Dữ liệu nhà cung cấp sẽ được thêm vào đây bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Phân trang -->
                                    <nav aria-label="Page navigation" style="margin-top: 15px;">
                                        <ul class="pagination justify-content-center" id="pagination">
                                            <!-- Các nút phân trang sẽ được thêm vào đây bằng JavaScript -->
                                        </ul>
                                        <div id="paginationInfo" class="text-center mt-2">
                                            <!-- Thông tin phân trang sẽ được hiển thị ở đây -->
                                        </div>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- content-wrapper ends -->
                <!-- partial:partials/_footer.html -->
                <footer class="footer" id="footer"></footer>
                <!-- partial -->
            </div>

            <!-- Modal để thêm/sửa nhà cung cấp -->
            <div class="modal fade" id="nhaCungCapModal" tabindex="-1" aria-labelledby="nhaCungCapModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="nhaCungCapModalLabel"
                                style="font-family: 'Times New Roman', Times, serif;">Thêm/Sửa Nhà Cung Cấp</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="nhaCungCapForm" style="font-family: 'Times New Roman', Times, serif;">
                                <div class="mb-3" style="display: none;">
                                    <!-- Ẩn cột MaNCC -->
                                    <label for="maNCC" class="form-label">Mã Nhà Cung Cấp</label>
                                    <input type="text" class="form-control" id="maNCC" name="maNCC" required
                                        readonly>
                                    <!-- Mã NCC là readonly và được tạo tự động -->
                                    <div id="maNCCError" class="invalid-feedback"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="tenNCC" class="form-label">Tên Nhà Cung Cấp</label>
                                    <input type="text" class="form-control" id="tenNCC" name="tenNCC" required>
                                    <div id="tenNCCError" class="invalid-feedback"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
                                    <input type="text" class="form-control" id="soDienThoai" name="soDienThoai"
                                        required>
                                    <div id="soDienThoaiError" class="invalid-feedback"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                    <div id="emailError" class="invalid-feedback"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="diaChi" class="form-label">Địa Chỉ</label>
                                    <input type="text" class="form-control" id="diaChi" name="diaChi">
                                    <div id="diaChiError" class="invalid-feedback"></div>
                                </div>
                                <input type="hidden" id="isEdit" name="isEdit" value="false">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                                style="font-family: 'Times New Roman', Times, serif;">Đóng</button>
                            <button type="button" class="btn btn-primary" id="btnSaveNhaCungCap"
                                style="font-family: 'Times New Roman', Times, serif;">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <script src="../../assets/js/settings.js"></script>
    <script src="../../assets/js/todolist.js"></script>
    <script src="../../assets/js/jquery.cookie.js"></script>
    <script>
        const IMAGE_PATH_1 = "/Admin/src/assets/images/nhanVien/";
        const LOGIN_PAGE_URL = "/Admin/src/login.html";

        let navbarLoaded = false;
        let sidebarLoaded = false;
        function checkAllLoaded() {
            if (navbarLoaded && sidebarLoaded) {
                checkLoginStatus();
                loadNhaCungCaps();
            }
        }
        // Các hàm để tải navbar, sidebar và footer từ các file HTML
        fetch("/Admin/src/partials/_navbar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("navbar-placeholder").innerHTML = data;
                navbarLoaded = true;
                checkAllLoaded();
            })
            .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>
    <script>
        fetch("/Admin/src/partials/_sidebar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("sidebar").innerHTML = data;
                sidebarLoaded = true;
                checkAllLoaded();
            })
            .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>
    <script>
        fetch("/Admin/src/partials/_footer.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("footer").innerHTML = data;
            })
            .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>
    <script>
        const apiUrl = 'https://localhost:7203/api/NhaCungCap';
        const tableBody = document.getElementById('tableBody');
        const btnAddNhaCungCap = document.getElementById('btnAddNhaCungCap');
        const nhaCungCapModal = new bootstrap.Modal(document.getElementById('nhaCungCapModal'));
        const nhaCungCapForm = document.getElementById('nhaCungCapForm');
        const btnSaveNhaCungCap = document.getElementById('btnSaveNhaCungCap');
        const isEdit = document.getElementById('isEdit');
        const maNCCInput = document.getElementById('maNCC');  //Thêm dòng này

        // Get references to the search and sort elements
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const sortOrderSelect = document.getElementById('sortOrderSelect');

        //Phân trang
        let currentPage = 1;
        const pageSize = 5;  //Số lượng item một trang
        let allNhaCungCaps = []; // Lưu trữ tất cả nhà cung cấp đã tải

        // Elements for pagination
        const pagination = document.getElementById("pagination");
        const paginationInfo = document.getElementById("paginationInfo");

        // Regular expressions for validation
        const phoneRegex = /^(\+?\d{1,4}[\s-])?(0?\d{1,3})[\s-]?\d{3}[\s-]?\d{3,4}$/;
        const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;

        // Function to build API URL with search, sort, and pagination parameters
        function buildApiUrl(searchTerm = '', sortBy = '', sortOrder = 'asc', page = 1, pageSize = 5) {
            let url = apiUrl + '?';

            if (searchTerm) {
                url += 'searchTerm=' + encodeURIComponent(searchTerm) + '&';
            }

            if (sortBy) {
                url += 'sortBy=' + encodeURIComponent(sortBy) + '&';
            }

            if (sortOrder) {
                url += 'sortOrder=' + encodeURIComponent(sortOrder) + '&';
            }

            //Remove pagination parameters from here, we'll handle it client-side

            // Remove the trailing '&' if any
            if (url.endsWith('&')) {
                url = url.slice(0, -1);
            }
            return url;
        }

        // Function to fetch data from API and display on the table
        async function loadNhaCungCaps() {
            const url = buildApiUrl(searchInput.value, sortSelect.value, sortOrderSelect.value);

            try {
                const response = await fetch(url);
                allNhaCungCaps = await response.json(); // Store all the data

                renderNhaCungCaps(); // Render the data with pagination
            } catch (error) {
                console.error('Error loading data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi tải dữ liệu. Vui lòng kiểm tra console.',
                });
            }
        }

        function renderNhaCungCaps() {
            tableBody.innerHTML = ''; // Clear old data

            // Apply Search
            let filteredNhaCungCaps = [...allNhaCungCaps]; // Create a copy

            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredNhaCungCaps = filteredNhaCungCaps.filter(ncc =>
                    ncc.tenNCC.toLowerCase().includes(searchTerm) ||
                    (ncc.email && ncc.email.toLowerCase().includes(searchTerm)) ||
                    (ncc.diaChi && ncc.diaChi.toLowerCase().includes(searchTerm) ||
                        (ncc.soDienThoai && ncc.soDienThoai.includes(searchTerm)))
                );
            }

            // Apply Sort
            const sortBy = sortSelect.value;
            const sortOrder = sortOrderSelect.value;

            if (sortBy) {
                filteredNhaCungCaps.sort((a, b) => {
                    let comparison = 0;

                    if (sortBy === 'mancc') {
                        comparison = a.maNCC.localeCompare(b.maNCC);
                    } else if (sortBy === 'tenncc') {
                        comparison = a.tenNCC.localeCompare(b.tenNCC);
                    } else if (sortBy === 'email') {
                        comparison = (a.email || '').localeCompare(b.email || ''); // Ensure no null errors
                    }

                    return sortOrder === 'desc' ? -comparison : comparison;
                });
            }


            // Pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pagedNhaCungCaps = filteredNhaCungCaps.slice(startIndex, endIndex);


            pagedNhaCungCaps.forEach(nhaCungCap => {
                const row = `
                    <tr>
                        <td>${nhaCungCap.maNCC}</td>
                        <td>${nhaCungCap.tenNCC}</td>
                        <td>${nhaCungCap.soDienThoai || ''}</td>
                        <td>${nhaCungCap.email || ''}</td>
                        <td>${nhaCungCap.diaChi || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary mr-2 btnEdit" data-id="${nhaCungCap.maNCC}" style="font-family: 'Times New Roman', Times, serif;"><i class="mdi mdi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger mr-2 btnDelete" data-id="${nhaCungCap.maNCC}" style="font-family: 'Times New Roman', Times, serif;"><i class="mdi mdi-delete"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Assign events for Edit and Delete buttons after adding to DOM
            document.querySelectorAll('.btnEdit').forEach(button => {
                button.addEventListener('click', editNhaCungCap);
            });

            document.querySelectorAll('.btnDelete').forEach(button => {
                button.addEventListener('click', deleteNhaCungCap);
            });

            renderPagination(filteredNhaCungCaps.length);
            updatePaginationInfo(filteredNhaCungCaps.length);

        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            pagination.innerHTML = "";

            let prevLi = document.createElement("li");
            prevLi.classList.add("page-item");
            if (currentPage === 1) {
                prevLi.classList.add("disabled");
            }
            const prevLink = document.createElement("a");
            prevLink.classList.add("page-link");
            prevLink.href = "#";
            prevLink.innerHTML = "«";
            prevLink.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderNhaCungCaps();
                }
            });
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);

            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement("li");
                pageLi.classList.add("page-item");
                if (i === currentPage) {
                    pageLi.classList.add("active");
                }
                const pageLink = document.createElement("a");
                pageLink.classList.add("page-link");
                pageLink.href = "#";
                pageLink.innerText = i;
                pageLink.addEventListener("click", () => {
                    currentPage = i;
                    renderNhaCungCaps();
                });
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }

            let nextLi = document.createElement("li");
            nextLi.classList.add("page-item");
            if (currentPage === totalPages || totalPages === 0) {
                nextLi.classList.add("disabled");
            }
            const nextLink = document.createElement("a");
            nextLink.classList.add("page-link");
            nextLink.href = "#";
            nextLink.innerHTML = "»";
            nextLink.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderNhaCungCaps();
                }
            });
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }

        function updatePaginationInfo(totalItems) {
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalItems);
        }

        // Event listener for search input
        searchInput.addEventListener('input', () => {
            currentPage = 1; // Reset to first page on search
            renderNhaCungCaps();
        });

        // Event listeners for sort select boxes
        sortSelect.addEventListener('change', () => {
            currentPage = 1; // Reset to first page on sort
            renderNhaCungCaps();
        });

        sortOrderSelect.addEventListener('change', () => {
            currentPage = 1; // Reset to first page on sortOrder
            renderNhaCungCaps();
        });

        // Load initial data with default values.
        loadNhaCungCaps();

        // Function to generate the next MaNCC
        function generateNextMaNCC() {
            let maxMaNCC = 0;
            const table = document.getElementById("tableBody");
            const rows = table.querySelectorAll("tr");

            rows.forEach(row => {
                const maNCC = row.querySelector("td:first-child").innerText;
                const number = parseInt(maNCC.slice(3)); // Lấy phần số sau "NCC"
                if (!isNaN(number) && number > maxMaNCC) {
                    maxMaNCC = number;
                }
            });

            const nextNumber = maxMaNCC + 1;
            const nextMaNCC = "NCC" + String(nextNumber).padStart(3, '0'); // Tạo mã mới với padding
            return nextMaNCC;
        }

        // Function to add NhaCungCap
        btnAddNhaCungCap.addEventListener('click', () => {
            nhaCungCapForm.reset(); // Reset form
            isEdit.value = 'false'; // Set mode to add new
            clearValidationErrors();

            //Generate and set the next MaNCC
            const nextMaNCC = generateNextMaNCC();
            maNCCInput.value = nextMaNCC; //Gán mã NCC mới tạo vào input
            nhaCungCapModal.show();
        });

        // Function to edit NhaCungCap
        async function editNhaCungCap(event) {
            const id = event.target.dataset.id;
            isEdit.value = 'true';
            nhaCungCapForm.reset(); // Reset form
            clearValidationErrors();
            try {
                const response = await fetch(`${apiUrl}/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const nhaCungCap = await response.json();

                // Fill data into the form
                nhaCungCapForm.maNCC.value = nhaCungCap.maNCC;
                nhaCungCapForm.tenNCC.value = nhaCungCap.tenNCC;
                nhaCungCapForm.soDienThoai.value = nhaCungCap.soDienThoai || '';
                nhaCungCapForm.email.value = nhaCungCap.email || '';
                nhaCungCapForm.diaChi.value = nhaCungCap.diaChi || '';

                nhaCungCapModal.show(); // Show modal
            } catch (error) {
                console.error('Error loading NhaCungCap data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi tải dữ liệu nhà cung cấp.',
                });
            }
        }

        // Function to delete NhaCungCap
        async function deleteNhaCungCap(event) {
            const id = event.target.dataset.id;
            Swal.fire({
                title: 'Bạn có chắc chắn muốn xóa nhà cung cấp này không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, Xóa!',
                cancelButtonText: 'Không, Hủy!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`${apiUrl}/${id}`, {
                            method: 'DELETE',
                        });

                        if (response.status === 204) {
                            Swal.fire(
                                'Đã xóa!',
                                'Nhà cung cấp đã được xóa.',
                                'success'
                            );
                            loadNhaCungCaps();  //Load lại trang hiện tại
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: 'Xóa không thành công. Vui lòng kiểm tra console.',
                            });
                            console.error('Error:', response.status);
                        }
                    } catch (error) {
                        console.error('Error deleting NhaCungCap:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Lỗi khi xóa nhà cung cấp. Vui lòng kiểm tra console.',
                        });
                    }
                }
            });
        }

        // Function to clear validation errors
        function clearValidationErrors() {
            document.querySelectorAll('.invalid-feedback').forEach(element => {
                element.textContent = ''; // Xóa nội dung của các phần tử báo lỗi
            });
            document.querySelectorAll('.form-control').forEach(element => {
                element.classList.remove('is-invalid'); // Xóa class 'is-invalid' để bỏ hiệu ứng báo lỗi
            });
        }
        // Function to display validation errors
        function displayValidationError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            if (errorElement && inputElement) {
                errorElement.textContent = message; // Đặt nội dung của phần tử báo lỗi
                inputElement.classList.add('is-invalid'); // Thêm class 'is-invalid' để hiển thị lỗi (Bootstrap)
            }
        }

        // Function to validate the form
        async function validateForm() {
            clearValidationErrors();
            let isValid = true;

            // Validate TenNCC
            const tenNCCValue = document.getElementById('tenNCC').value.trim();
            if (tenNCCValue === '') {
                displayValidationError('tenNCC', 'Tên nhà cung cấp là bắt buộc.');
                isValid = false;
            } else if (tenNCCValue.length > 255) {
                displayValidationError('tenNCC', 'Tên nhà cung cấp không được vượt quá 255 ký tự.');
                isValid = false;
            }

            // Validate SoDienThoai
            const soDienThoaiValue = document.getElementById('soDienThoai').value.trim();
            if (soDienThoaiValue === '') {
                displayValidationError('soDienThoai', 'Số điện thoại là bắt buộc.');
                isValid = false;
            } else if (!/^\d{10,11}$/.test(soDienThoaiValue)) {
                displayValidationError('soDienThoai', 'Số điện thoại phải là 10 hoặc 11 chữ số.');
                isValid = false;
            }

            // Kiểm tra trùng số điện thoại
            const isEditMode = isEdit.value === 'true';
            if (!isEditMode) {
                // Thêm mới: Kiểm tra xem có NCC nào có số điện thoại này chưa
                const isDuplicate = allNhaCungCaps.some(ncc => ncc.soDienThoai === soDienThoaiValue);
                if (isDuplicate) {
                    displayValidationError('soDienThoai', 'Số điện thoại này đã được sử dụng.');
                    isValid = false;
                }
            } else {
                // Chỉnh sửa: Kiểm tra số điện thoại khác với số điện thoại hiện tại
                const maNCC = document.getElementById('maNCC').value;
                const currentNCC = allNhaCungCaps.find(ncc => ncc.maNCC === maNCC);
                if (currentNCC && currentNCC.soDienThoai !== soDienThoaiValue) {
                    const isDuplicate = allNhaCungCaps.some(ncc => ncc.soDienThoai === soDienThoaiValue && ncc.maNCC !== maNCC);
                    if (isDuplicate) {
                        displayValidationError('soDienThoai', 'Số điện thoại này đã được sử dụng.');
                        isValid = false;
                    }
                }
            }


            // Validate Email
            const emailValue = document.getElementById('email').value.trim();
            if (emailValue !== '' && !/^[^\s@]+@[^@\s]+\.[^\s@]+$/.test(emailValue)) {
                displayValidationError('email', 'Địa chỉ email không hợp lệ.');
                isValid = false;
            }

            //Kiểm tra email trùng
            if (!isEditMode) {  //Chỉ kiểm tra trùng lặp khi thêm mới
                const isDuplicateEmail = allNhaCungCaps.some(ncc => ncc.email === emailValue && emailValue !== "");
                if (isDuplicateEmail) {
                    displayValidationError('email', 'Địa chỉ email này đã được sử dụng.');
                    isValid = false;
                }
            } else {  //Kiểm tra khi chỉnh sửa
                //Lấy mã NCC đang chỉnh sửa
                const maNCC = document.getElementById('maNCC').value;
                //Lọc ra NCC đang chỉnh sửa
                const currentNCC = allNhaCungCaps.find(ncc => ncc.maNCC === maNCC);

                //Nếu email thay đổi, kiểm tra xem có trùng với NCC khác không
                if (currentNCC && currentNCC.email !== emailValue) {
                    const isDuplicateEmail = allNhaCungCaps.some(ncc => ncc.email === emailValue && ncc.maNCC !== maNCC && emailValue !== "");
                    if (isDuplicateEmail) {
                        displayValidationError('email', 'Địa chỉ email này đã được sử dụng.');
                        isValid = false;
                    }
                }

            }

            // Validate DiaChi
            const diaChiValue = document.getElementById('diaChi').value.trim();
            if (diaChiValue.length > 500) {
                displayValidationError('diaChi', 'Địa chỉ không được vượt quá 500 ký tự.');
                isValid = false;
            }

            return isValid;
        }


        // Function to save NhaCungCap (add or edit)
        btnSaveNhaCungCap.addEventListener('click', async () => {
            if (!await validateForm()) {
                return;
            }

            const formData = new FormData(nhaCungCapForm);
            const nhaCungCapData = {
                maNCC: formData.get('maNCC'),
                tenNCC: formData.get('tenNCC'),
                soDienThoai: formData.get('soDienThoai'),
                email: formData.get('email'),
                diaChi: formData.get('diaChi')
            };

            const isEditMode = isEdit.value === 'true';

            try {
                let response;
                if (isEditMode) {
                    response = await fetch(`${apiUrl}/${nhaCungCapData.maNCC}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(nhaCungCapData)
                    });
                } else {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(nhaCungCapData)
                    });
                }

                if (response.ok || response.status === 204) {
                    Swal.fire({
                        icon: 'success',
                        title: isEditMode ? 'Cập nhật thành công!' : 'Thêm thành công!',
                        text: isEditMode ? 'Nhà cung cấp đã được cập nhật.' : 'Nhà cung cấp đã được thêm.',
                    });
                    nhaCungCapModal.hide();
                    loadNhaCungCaps();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Thêm/sửa không thành công. Vui lòng kiểm tra console.',
                    });
                    console.error('Error:', response.status);
                }
            } catch (error) {
                console.error('Error adding/editing NhaCungCap:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi thêm/sửa nhà cung cấp. Vui lòng kiểm tra console.',
                });
            }
        });
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const hoTen = localStorage.getItem('hoTen');
            const userRole = localStorage.getItem('userRole');
            let hinhAnh = localStorage.getItem('hinhAnh');

            const loginButton = document.getElementById('loginButton');
            const profileDropdown = document.getElementById('profileDropdown');
            const sidebar = document.getElementById('sidebar');

            if (token) {
                loginButton.style.display = 'none';
                profileDropdown.style.display = 'block';

                const navbarHoTen = document.querySelector('#profileDropdown .nav-profile-text p');
                const navbarHinhAnh = document.querySelector('#profileDropdown .nav-profile-img img');

                if (navbarHoTen) {
                    navbarHoTen.textContent = hoTen;
                }
                if (navbarHinhAnh) {
                    if (hinhAnh && !hinhAnh.startsWith('http')) {
                        hinhAnh = `${IMAGE_PATH_1}${hinhAnh}`;
                    }
                    navbarHinhAnh.src = hinhAnh;
                }

                const sidebarHoTen = document.getElementById("sidebar-hoTen");
                
const sidebarVaiTro = document.getElementById("sidebar-vaiTro");
                const sidebarHinhAnh = document.getElementById("sidebar-hinhAnh");

                if (sidebarHoTen) {
                    sidebarHoTen.textContent = hoTen;
                }
                if (sidebarVaiTro) {
                    sidebarVaiTro.textContent = userRole;
                }
                if (sidebarHinhAnh) {
                    sidebarHinhAnh.src = hinhAnh;
                }

                if (userRole === 'Nhân viên') {
                    const quanLyNguoiDungLi = Array.from(sidebar.querySelectorAll('li a'))
                        .find(a => a.textContent.trim() === 'Quản lý người dùng')
                        ?.closest('li');

                    if (quanLyNguoiDungLi) {
                        const quanLyNhaCungCapLink = quanLyNguoiDungLi.querySelector('a[href*="nhacungcap"]');

                        if (quanLyNhaCungCapLink) {
                            quanLyNhaCungCapLink.closest('li').style.display = 'none';
                        }
                    }
                } else if (userRole === 'Quản lý kho') {
                    const quanLyNguoiDungLi = Array.from(sidebar.querySelectorAll('li a'))
                        .find(a => a.textContent.trim() === 'Quản lý người dùng')
                        ?.closest('li');

                    if (quanLyNguoiDungLi) {
                        const quanLyNhaCungCapLink = quanLyNguoiDungLi.querySelector('a[href*="nhacungcap"]');

                        if (quanLyNhaCungCapLink) {
                            quanLyNhaCungCapLink.closest('li').style.display = 'block';
                        }
                    }
                }

                document.getElementById('logoutButton').addEventListener('click', function () {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('hoTen');
                    localStorage.removeItem('hinhAnh');
                    localStorage.removeItem('maNV');
                    window.location.href = "/Admin/src/index.html";
                });

            } else {
                window.location.href = LOGIN_PAGE_URL;
            }
        }
    </script>
</body>

</html>