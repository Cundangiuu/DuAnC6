<!DOCTYPE html>
<html lang="vi">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Trang chủ Admin</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../../assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="../../assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="../../assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="../../assets/images/favicon.png" />

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
</head>

<body>
    <div class="container-scroller">
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row"
            id="navbar-placeholder"></nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar"></nav>
            <!-- partial -->
            <div class="main-panel" style="font-family: 'Times New Roman', Times, serif;">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title" style="font-family: 'Times New Roman', Times, serif;">Quản lý Khách hàng
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#">Quản lý</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Khách hàng</li>
                            </ol>
                        </nav>
                    </div>
                    <!-- Tìm kiếm và sắp xếp -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Tìm kiếm:</label>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Nhập tên, email, địa chỉ...">
                        </div>
                        <div class="col-md-4">
                            <label for="sortSelect" class="form-label">Sắp xếp theo:</label>
                            <select class="form-select" id="sortSelect"
                                style="font-family: 'Times New Roman', Times, serif;">
                                <option value="">Mặc định</option>
                                <option value="makh">Mã Khách hàng</option>
                                <option value="tenkh">Tên Khách hàng</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="sortOrderSelect" class="form-label">Thứ tự:</label>
                            <select class="form-select" id="sortOrderSelect"
                                style="font-family: 'Times New Roman', Times, serif;">
                                <option value="asc">Tăng dần</option>
                                <option value="desc">Giảm dần</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" style="font-family: 'Times New Roman', Times, serif;">
                        <div class="col-lg-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title" style="font-family: 'Times New Roman', Times, serif;">Danh sách
                                        Khách hàng</h4>
                                    <p class="card-description" style="font-family: 'Times New Roman', Times, serif;">
                                        Quản lý thông tin khách hàng
                                    </p>
                                    <!-- Nút thêm khách hàng -->
                                    <button class="btn btn-primary mb-3" id="btnAddKhachHang"
                                        style="font-family: 'Times New Roman', Times, serif;"><i
                                            class="mdi mdi-plus-circle-outline"></i> Thêm Khách hàng</button>

                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Mã khách
                                                        hàng</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Tên khách
                                                        hàng</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Số Điện
                                                        Thoại</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Email</th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Địa Chỉ
                                                    </th>
                                                    <th style="font-family: 'Times New Roman', Times, serif;">Hành động
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                <!-- Dữ liệu khách hàng sẽ được thêm vào đây bằng JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Phân trang -->
                                    <nav aria-label="Page navigation" style="margin-top: 15px;">
                                        <ul class="pagination justify-content-center" id="pagination">
                                            <!-- Các nút phân trang sẽ được thêm vào đây bằng JavaScript -->
                                        </ul>
                                        <div id="paginationInfo" class="text-center mt-2">
                                            <!-- Thông tin phân trang sẽ được hiển thị ở đây -->
                                        </div>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- content-wrapper ends -->
                <!-- partial:partials/_footer.html -->
                <footer class="footer" id="footer"></footer>
                <!-- partial -->
            </div>

            <!-- Modal để thêm/sửa khách hàng -->
            <div class="modal fade" id="khachHangModal" tabindex="-1" aria-labelledby="khachHangModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content" style="font-family: 'Times New Roman', Times, serif;">
                        <div class="modal-header">
                            <h5 class="modal-title" id="khachHangModalLabel"
                                style="font-family: 'Times New Roman', Times, serif;">Thêm/Sửa Khách hàng</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="khachHangForm">
                                <div class="mb-3" style="display: none;">
                                    <!-- Ẩn cột MaKH -->
                                    <label for="maKH" class="form-label">Mã khách hàng</label>
                                    <input type="text" class="form-control" id="maKH" name="maKH" required readonly>
                                    <!-- Mã KH sẽ tự động tạo và không cho phép sửa -->
                                    <div class="invalid-feedback" id="maKH-error"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="tenKH" class="form-label">Tên khách hàng</label>
                                    <input type="text" class="form-control" id="tenKH" name="tenKH" required>
                                    <div class="invalid-feedback" id="tenKH-error"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
                                    <input type="text" class="form-control" id="soDienThoai" name="soDienThoai"
                                        required>
                                    <div class="invalid-feedback" id="soDienThoai-error"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                    <div class="invalid-feedback" id="email-error"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="diaChi" class="form-label">Địa Chỉ</label>
                                    <input type="text" class="form-control" id="diaChi" name="diaChi">
                                    <div class="invalid-feedback" id="diaChi-error"></div>
                                </div>
                                <input type="hidden" id="isEdit" name="isEdit" value="false">
                                <!-- Ẩn trường này để biết đang ở chế độ thêm hay sửa -->
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                                style="font-family: 'Times New Roman', Times, serif;">Đóng</button>
                            <button type="button" class="btn btn-primary" id="btnSaveKhachHang"
                                style="font-family: 'Times New Roman', Times, serif;">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <script src="../../assets/js/settings.js"></script>
    <script src="../../assets/js/todolist.js"></script>
    <script src="../../assets/js/jquery.cookie.js"></script>
    <script>
        const IMAGE_PATH_1 = "/Admin/src/assets/images/nhanVien/";
        const LOGIN_PAGE_URL = "login.html";

        let navbarLoaded = false;
        let sidebarLoaded = false;
        function checkAllLoaded() {
            if (navbarLoaded && sidebarLoaded) {
                checkLoginStatus();
            }
        }
        // Các hàm để tải navbar, sidebar và footer từ các file HTML
        fetch("/Admin/src/partials/_navbar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("navbar-placeholder").innerHTML = data;
                navbarLoaded = true;
                checkAllLoaded();
            })
            .catch(error => console.error("Lỗi khi tải navbar:", error));
    </script>
    <script>
        fetch("/Admin/src/partials/_sidebar.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("sidebar").innerHTML = data;
                sidebarLoaded = true;
                checkAllLoaded();
            })
            .catch(error => console.error("Lỗi khi tải sidebar:", error));
    </script>
    <script>
        fetch("/Admin/src/partials/_footer.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("footer").innerHTML = data;
            })
            .catch(error => console.error("Lỗi khi tải footer:", error));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>
    <script>
        const apiUrl = 'https://localhost:7203/api/KhachHang';
        const tableBody = document.getElementById('tableBody');
        const btnAddKhachHang = document.getElementById('btnAddKhachHang');
        const khachHangModal = new bootstrap.Modal(document.getElementById('khachHangModal'));
        const khachHangForm = document.getElementById('khachHangForm');
        const btnSaveKhachHang = document.getElementById('btnSaveKhachHang');
        const isEdit = document.getElementById('isEdit');
        const maKHInput = document.getElementById('maKH'); // Lấy tham chiếu đến input MaKH

        // Get references to the search and sort elements
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const sortOrderSelect = document.getElementById('sortOrderSelect');

        //Phân trang
        let currentPage = 1;
        const pageSize = 5;  //Số lượng item một trang
        let allKhachHangs = []; // Lưu trữ tất cả khách hàng đã tải

        // Elements for pagination
        const pagination = document.getElementById("pagination");
        const paginationInfo = document.getElementById("paginationInfo");


        // Function to build API URL with search, sort, and pagination parameters
        function buildApiUrl(searchTerm = '', sortBy = '', sortOrder = 'asc', page = 1, pageSize = 5) {
            let url = apiUrl + '?';

            if (searchTerm) {
                url += 'searchTerm=' + encodeURIComponent(searchTerm) + '&';
            }

            if (sortBy) {
                url += 'sortBy=' + encodeURIComponent(sortBy) + '&';
            }

            if (sortOrder) {
                url += 'sortOrder=' + encodeURIComponent(sortOrder) + '&';
            }

            //Remove pagination parameters from here, we'll handle it client-side

            // Remove the trailing '&' if any
            if (url.endsWith('&')) {
                url = url.slice(0, -1);
            }
            return url;
        }

        // Function to fetch data from API and display on the table
        async function loadKhachHangs() {
            const url = buildApiUrl(searchInput.value, sortSelect.value, sortOrderSelect.value);

            try {
                const response = await fetch(url);
                allKhachHangs = await response.json(); // Store all the data

                renderKhachHangs(); // Render the data with pagination
            } catch (error) {
                console.error('Error loading data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi tải dữ liệu. Vui lòng kiểm tra console.',
                });
            }
        }

        function renderKhachHangs() {
            tableBody.innerHTML = ''; // Clear old data

            // Apply Search
            let filteredKhachHangs = [...allKhachHangs]; // Create a copy

            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredKhachHangs = filteredKhachHangs.filter(kh =>
                    kh.tenKH.toLowerCase().includes(searchTerm) ||
                    (kh.email && kh.email.toLowerCase().includes(searchTerm)) ||
                    (kh.diaChi && kh.diaChi.toLowerCase().includes(searchTerm)) ||
                    (kh.soDienThoai && kh.soDienThoai.includes(searchTerm))
                );
            }

            // Apply Sort
            const sortBy = sortSelect.value;
            const sortOrder = sortOrderSelect.value;

            if (sortBy) {
                filteredKhachHangs.sort((a, b) => {
                    let comparison = 0;

                    if (sortBy === 'makh') {
                        comparison = a.maKH.localeCompare(b.maKH);
                    } else if (sortBy === 'tenkh') {
                        comparison = a.tenKH.localeCompare(b.tenKH);
                    } else if (sortBy === 'email') {
                        comparison = (a.email || '').localeCompare(b.email || ''); // Ensure no null errors
                    }

                    return sortOrder === 'desc' ? -comparison : comparison;
                });
            }


            // Pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pagedKhachHangs = filteredKhachHangs.slice(startIndex, endIndex);


            pagedKhachHangs.forEach(khachHang => {
                const row = `
                    <tr>
                        <td>${khachHang.maKH}</td>
                        <td>${khachHang.tenKH}</td>
                        <td>${khachHang.soDienThoai || ''}</td>
                        <td>${khachHang.email || ''}</td>
                        <td>${khachHang.diaChi || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary mr-2 btnEdit" data-id="${khachHang.maKH}" style="font-family: 'Times New Roman', Times, serif;"><i class="mdi mdi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger mr-2 btnDelete" data-id="${khachHang.maKH}" style="font-family: 'Times New Roman', Times, serif;"><i class="mdi mdi-delete"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Assign events for Edit and Delete buttons after adding to DOM
            document.querySelectorAll('.btnEdit').forEach(button => {
                button.addEventListener('click', editKhachHang);
            });

            document.querySelectorAll('.btnDelete').forEach(button => {
                button.addEventListener('click', deleteKhachHang);
            });

            renderPagination(filteredKhachHangs.length);
            updatePaginationInfo(filteredKhachHangs.length);

        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            pagination.innerHTML = "";

            let prevLi = document.createElement("li");
            prevLi.classList.add("page-item");
            if (currentPage === 1) {
                prevLi.classList.add("disabled");
            }
            const prevLink = document.createElement("a");
            prevLink.classList.add("page-link");
            prevLink.href = "#";
            prevLink.innerHTML = "«";
            prevLink.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderKhachHangs();
                }
            });
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);

            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement("li");
                pageLi.classList.add("page-item");
                if (i === currentPage) {
                    pageLi.classList.add("active");
                }
                const pageLink = document.createElement("a");
                pageLink.classList.add("page-link");
                pageLink.href = "#";
                pageLink.innerText = i;
                pageLink.addEventListener("click", () => {
                    currentPage = i;
                    renderKhachHangs();
                });
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }

            let nextLi = document.createElement("li");
            nextLi.classList.add("page-item");
            if (currentPage === totalPages || totalPages === 0) {
                nextLi.classList.add("disabled");
            }
            const nextLink = document.createElement("a");
            nextLink.classList.add("page-link");
            nextLink.href = "#";
            nextLink.innerHTML = "»";
            nextLink.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderKhachHangs();
                }
            });
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }

        function updatePaginationInfo(totalItems) {
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalItems);
        }


        // Event listener for search input
        searchInput.addEventListener('input', () => {
            currentPage = 1; // Reset to first page on search
            renderKhachHangs();
        });

        // Event listeners for sort select boxes
        sortSelect.addEventListener('change', () => {
            currentPage = 1; // Reset to first page on sort
            renderKhachHangs();
        });

        sortOrderSelect.addEventListener('change', () => {
            currentPage = 1; // Reset to first page on sortOrder
            renderKhachHangs();
        });

        // Load initial data with default values.
        loadKhachHangs();


        // Function to generate the next MaKH
        function generateNextMaKH() {
            let maxMaKH = 0;
            const table = document.getElementById("tableBody");
            const rows = table.querySelectorAll("tr");

            rows.forEach(row => {
                const maKH = row.querySelector("td:first-child").innerText;
                const number = parseInt(maKH.slice(2)); // Lấy phần số sau "KH"
                if (!isNaN(number) && number > maxMaKH) {
                    maxMaKH = number;
                }
            });

            const nextNumber = maxMaKH + 1;
            const nextMaKH = "KH" + String(nextNumber).padStart(3, '0'); // Tạo mã mới với padding
            return nextMaKH;
        }

        // Function to add customer
        btnAddKhachHang.addEventListener('click', () => {
            khachHangForm.reset(); // Reset form
            isEdit.value = 'false'; // Set mode to add new

            // Generate and set the next MaKH
            const nextMaKH = generateNextMaKH();
            maKHInput.value = nextMaKH; // Gán mã KH mới tạo vào input

            // Clear any previous validation errors
            clearValidationErrors();

            khachHangModal.show();
        });

        // Function to edit customer
        async function editKhachHang(event) {
            const id = event.target.dataset.id;
            isEdit.value = 'true';
            khachHangForm.reset(); // Reset form

            // Clear any previous validation errors
            clearValidationErrors();

            try {
                const response = await fetch(`${apiUrl}/${id}`);
                const khachHang = await response.json();

                // Fill data into the form
                khachHangForm.maKH.value = khachHang.maKH;
                khachHangForm.tenKH.value = khachHang.tenKH;
                khachHangForm.soDienThoai.value = khachHang.soDienThoai || '';
                khachHangForm.email.value = khachHang.email || '';
                khachHangForm.diaChi.value = khachHang.diaChi || '';

                khachHangModal.show(); // Show modal
            } catch (error) {
                console.error('Error loading customer data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi tải dữ liệu khách hàng.',
                });
            }
        }

        // Function to delete customer
        async function deleteKhachHang(event) {
            const id = event.target.dataset.id;
            Swal.fire({
                title: 'Bạn có chắc chắn muốn xóa khách hàng này không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có, Xóa!',
                cancelButtonText: 'Không, Hủy!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`${apiUrl}/${id}`, {
                            method: 'DELETE',
                        });

                        if (response.status === 204) {
                            Swal.fire(
                                'Đã xóa!',
                                'Khách hàng đã được xóa.',
                                'success'
                            );
                            loadKhachHangs(); // Load all data again to update table
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: 'Xóa không thành công. Vui lòng kiểm tra console.',
                            });
                            console.error('Error:', response.status);
                        }
                    } catch (error) {
                        console.error('Error deleting customer:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Lỗi khi xóa khách hàng. Vui lòng kiểm tra console.',
                        });
                    }
                }
            });
        }

        // Function to clear all validation errors
        function clearValidationErrors() {
            document.querySelectorAll('.invalid-feedback').forEach(element => {
                element.textContent = ''; // Xóa nội dung của các phần tử báo lỗi
            });
            document.querySelectorAll('.form-control').forEach(element => {
                element.classList.remove('is-invalid'); // Xóa class 'is-invalid' để bỏ hiệu ứng báo lỗi
            });
        }

        // Function to display validation errors
        function displayValidationError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + '-error');
            const inputElement = document.getElementById(fieldId);
            if (errorElement && inputElement) {
                errorElement.textContent = message; // Đặt nội dung của phần tử báo lỗi
                inputElement.classList.add('is-invalid'); // Thêm class 'is-invalid' để hiển thị lỗi (Bootstrap)
            }
        }

        // Function to validate the form
        async function validateForm() {
            clearValidationErrors(); // Xóa các lỗi cũ trước khi kiểm tra

            let isValid = true; // Biến để theo dõi trạng thái hợp lệ của form

            // Validate TenKH (Tên Khách hàng)
            const tenKHValue = document.getElementById('tenKH').value.trim();
            if (tenKHValue === '') {
                displayValidationError('tenKH', 'Tên khách hàng là bắt buộc.');
                isValid = false;
            } else if (tenKHValue.length > 255) {
                displayValidationError('tenKH', 'Tên khách hàng không được vượt quá 255 ký tự.');
                isValid = false;
            }

            // Validate SoDienThoai (Số Điện Thoại - Bắt buộc và phải là 10 hoặc 11 chữ số)
            const soDienThoaiValue = document.getElementById('soDienThoai').value.trim();
            if (soDienThoaiValue === '') {
                displayValidationError('soDienThoai', 'Số điện thoại là bắt buộc.');
                isValid = false;
            } else if (!/^\d{10,11}$/.test(soDienThoaiValue)) {
                displayValidationError('soDienThoai', 'Số điện thoại phải là 10 hoặc 11 chữ số.');
                isValid = false;
            }

            //Kiểm tra số điện thoại có trùng hay không
            const isEditMode = isEdit.value === 'true';
            if (!isEditMode) {  //Chỉ kiểm tra trùng lặp khi thêm mới
                const isDuplicateSDT = allKhachHangs.some(kh => kh.soDienThoai === soDienThoaiValue);

                if (isDuplicateSDT) {
                    displayValidationError('soDienThoai', 'Số điện thoại này đã được sử dụng.');
                    isValid = false;
                }
            } else {  //Kiểm tra khi chỉnh sửa
                //Lấy mã khách hàng đang chỉnh sửa
                const maKH = document.getElementById('maKH').value;
                //Lọc ra khách hàng đang chỉnh sửa
                const currentKhachHang = allKhachHangs.find(kh => kh.maKH === maKH);

                //Nếu số điện thoại thay đổi, kiểm tra xem có trùng với khách hàng khác không
                if (currentKhachHang && currentKhachHang.soDienThoai !== soDienThoaiValue) {
                    const isDuplicateSDT = allKhachHangs.some(kh => kh.soDienThoai === soDienThoaiValue && kh.maKH !== maKH);
                    if (isDuplicateSDT) {
                        displayValidationError('soDienThoai', 'Số điện thoại này đã được sử dụng.');
                        isValid = false;
                    }
                }

            }

            // Validate Email (Địa chỉ Email - Không bắt buộc, nhưng nếu có thì phải đúng định dạng)
            const emailValue = document.getElementById('email').value.trim();
            if (emailValue !== '' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailValue)) {
                displayValidationError('email', 'Địa chỉ email không hợp lệ.');
                isValid = false;
            }

            //kiểm tra email trùng
            if (!isEditMode) {
                const isDuplicateEmail = allKhachHangs.some(kh => kh.email === emailValue && emailValue !== "");
                if (isDuplicateEmail) {
                    displayValidationError('email', 'Địa chỉ email này đã được sử dụng.');
                    isValid = false;
                }
            } else {
                const maKH = document.getElementById('maKH').value;
                const currentKhachHang = allKhachHangs.find(kh => kh.maKH === maKH);
                if (currentKhachHang && currentKhachHang.email !== emailValue) {
                    const isDuplicateEmail = allKhachHangs.some(kh => kh.email === emailValue && kh.maKH !== maKH && emailValue !== "");
                    if (isDuplicateEmail) {
                        displayValidationError('email', 'Địa chỉ email này đã được sử dụng.');
                        isValid = false;
                    }
                }
            }

            // Validate DiaChi (Địa chỉ - Không bắt buộc, nhưng nếu có thì không được quá 500 ký tự)
            const diaChiValue = document.getElementById('diaChi').value.trim();
            if (diaChiValue.length > 500) {
                displayValidationError('diaChi', 'Địa chỉ không được vượt quá 500 ký tự.');
                isValid = false;
            }

            return isValid; // Trả về trạng thái hợp lệ của form
        }

        // Function to save customer (add or edit)
        btnSaveKhachHang.addEventListener('click', async () => {

            if (!await validateForm()) {
                return; // Dừng lại nếu form không hợp lệ
            }

            const formData = new FormData(khachHangForm);
            const khachHangData = {
                maKH: formData.get('maKH'),
                tenKH: formData.get('tenKH'),
                soDienThoai: formData.get('soDienThoai'),
                email: formData.get('email'),
                diaChi: formData.get('diaChi')
            };

            const isEditMode = isEdit.value === 'true'; // Kiểm tra xem có phải là chế độ sửa hay không

            try {
                let response;
                if (isEditMode) {
                    // Chế độ Sửa (Edit mode)
                    response = await fetch(`${apiUrl}/${khachHangData.maKH}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(khachHangData)
                    });
                } else {
                    // Chế độ Thêm (Add mode)
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(khachHangData)
                    });
                }

                if (response.ok || response.status === 204) { // Kiểm tra xem response có thành công hay không
                    Swal.fire({
                        icon: 'success',
                        title: isEditMode ? 'Cập nhật thành công!' : 'Thêm thành công!',
                        text: isEditMode ? 'Khách hàng đã được cập nhật.' : 'Khách hàng đã được thêm.',
                    });
                    khachHangModal.hide(); // Ẩn modal sau khi thành công
                    loadKhachHangs(); // Tải lại danh sách khách hàng
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Thêm/sửa không thành công. Vui lòng kiểm tra console.',
                    });
                    console.error('Error:', response.status);
                }
            } catch (error) {
                console.error('Error adding/editing customer:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Lỗi khi thêm/sửa khách hàng. Vui lòng kiểm tra console.',
                });
            }
        });

        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const hoTen = localStorage.getItem('hoTen');
            const userRole = localStorage.getItem('userRole');
            let hinhAnh = localStorage.getItem('hinhAnh');

            const loginButton = document.getElementById('loginButton');
            const profileDropdown = document.getElementById('profileDropdown');
            const sidebar = document.getElementById('sidebar');

            if (token) {
                loginButton.style.display = 'none';
                profileDropdown.style.display = 'block';

                const navbarHoTen = document.querySelector('#profileDropdown .nav-profile-text p');
                const navbarHinhAnh = document.querySelector('#profileDropdown .nav-profile-img img');

                if (navbarHoTen) {
                    navbarHoTen.textContent = hoTen;
                }
                if (navbarHinhAnh) {
                    if (hinhAnh && !hinhAnh.startsWith('http')) {
                        hinhAnh = `${IMAGE_PATH_1}${hinhAnh}`;
                    }
                    navbarHinhAnh.src = hinhAnh;
                }

                const sidebarHoTen = document.getElementById("sidebar-hoTen");
                const sidebarVaiTro = document.getElementById("sidebar-vaiTro");
                const sidebarHinhAnh = document.getElementById("sidebar-hinhAnh");

                if (sidebarHoTen) {
                    sidebarHoTen.textContent = hoTen;
                }
                if (sidebarVaiTro) {
                    sidebarVaiTro.textContent = userRole;
                }
                if (sidebarHinhAnh) {
                    sidebarHinhAnh.src = hinhAnh;
                }

                if (userRole === 'Nhân viên') {
                    const quanLyNguoiDungLi = Array.from(sidebar.querySelectorAll('li a'))
                        .find(a => a.textContent.trim() === 'Quản lý người dùng')
                        ?.closest('li');

                    if (quanLyNguoiDungLi) {
                        const quanLyKhachHangLink = quanLyNguoiDungLi.querySelector('a[href*="khachhang"]');

                        if (quanLyKhachHangLink) {
                            quanLyKhachHangLink.closest('li').style.display = 'none';
                        }
                    }
                } else if (userRole === 'Quản lý kho') {
                    const quanLyNguoiDungLi = Array.from(sidebar.querySelectorAll('li a'))
                        .find(a => a.textContent.trim() === 'Quản lý người dùng')
                        ?.closest('li');

                    if (quanLyNguoiDungLi) {
                        const quanLyKhachHangLink = quanLyNguoiDungLi.querySelector('a[href*="khachhang"]');

                        if (quanLyKhachHangLink) {
                            quanLyKhachHangLink.closest('li').style.display = 'block';
                        }
                    }
                }

                document.getElementById('logoutButton').addEventListener('click', function () {
                    localStorage.removeItem('token');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('hoTen');
                    localStorage.removeItem('hinhAnh');
                    localStorage.removeItem('maNV');
                    window.location.href = "/Admin/src/index.html";

                });

            } else {
                window.location.href = LOGIN_PAGE_URL;
            }
        }
    </script>
</body>

</html>